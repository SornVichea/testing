<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for light mode */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Lighter, more professional background */
            color: #2d3748; /* Darker, more professional default text color */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transition */
        }
        .bg-white { background-color: #ffffff; }
        .shadow-lg { box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.15), 0 6px 12px -4px rgba(0, 0, 0, 0.08); } /* More pronounced shadow */
        .bg-gray-50 { background-color: #fbfcfe; } /* Slightly lighter gray for sections */
        .bg-gray-200 { background-color: #e2e8f0; }
        .text-gray-800 { color: #1a202c; } /* Darker text for headings */
        .text-gray-700 { color: #2d3748; }
        .text-gray-600 { color: #4a5568; }
        .text-gray-500 { color: #718096; }

        /* Styles for dark mode */
        body.dark-mode {
            background-color: #1a202c; /* Deeper dark background */
            color: #e2e8f0; /* Light text color */
        }
        .dark-mode .bg-white { background-color: #2d3748; } /* Darker card background */
        .dark-mode .shadow-lg { box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.5), 0 6px 12px -4px rgba(0, 0, 0, 0.3); } /* Darker shadow for dark mode */
        .dark-mode .bg-gray-50 { background-color: #4a5568; } /* Darker section background */
        .dark-mode .bg-gray-200 { background-color: #5a6b80; }
        .dark-mode .text-gray-800 { color: #f7fafc; }
        .dark-mode .text-gray-700 { color: #e2e8f0; }
        .dark-mode .text-gray-600 { color: #cbd5e0; }
        .dark-mode .text-gray-500 { color: #a0aec0; }
        .dark-mode .bg-indigo-100 { background-color: #2c5282; } /* Darker indigo for alert in dark mode */
        .dark-mode .text-indigo-700 { color: #9f7aea; } /* Lighter indigo text for contrast */
        .dark-mode .bg-indigo-800 { background-color: #1a202c; } /* Sidebar dark background */
        .dark-mode .hover\:bg-indigo-700:hover { background-color: #2c5282; } /* Sidebar hover in dark mode */
        .dark-mode .active-link { background-color: #3182ce; } /* More distinct active link in dark mode */
        .dark-mode .border-indigo-700 { border-color: #4299e1; } /* Border in dark mode */

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        .dark-mode::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .dark-mode::-webkit-scrollbar-thumb {
            background: #718096;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark-mode::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Hide sections by default, show only the active one */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }

        /* Custom active link styling */
        .nav-link.active-link {
            background-color: #4c51bf; /* Deeper indigo for active link */
            font-weight: 600; /* Semi-bold for active link */
            box-shadow: inset 3px 0 0 0 #667eea; /* Left border highlight */
        }
        .dark-mode .nav-link.active-link {
            background-color: #3182ce; /* Dark mode active link */
            box-shadow: inset 3px 0 0 0 #63b3ed;
        }

        /* Table specific styles for better appearance */
        table {
            border-collapse: collapse; /* Ensures clean table borders */
        }
        th, td {
            padding: 1rem 1.5rem; /* Increased padding for table cells */
        }

        /* Form input focus styles for professionalism */
        .form-input-professional:focus {
            outline: none;
            border-color: #6366f1; /* Indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Light indigo ring */
        }
        .dark-mode .form-input-professional:focus {
            border-color: #63b3ed; /* Light blue for dark mode */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4); /* Darker indigo ring */
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.3); /* Stronger shadow for modal */
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        .dark-mode .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #718096;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .modal-close-button:hover {
            color: #e53e3e; /* Red on hover */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col sm:flex-row">
    <!-- Dashboard Layout (Always visible) -->
    <div id="dashboardLayout" class="w-full h-full flex flex-col sm:flex-row">
        <!-- Sidebar Navigation -->
        <aside class="w-full sm:w-64 bg-indigo-800 text-white flex flex-col p-4 shadow-lg sm:min-h-screen">
            <div class="text-2xl font-extrabold text-center mb-8 tracking-wide">Church Admin</div>

            <!-- Logged-in User Info (Simplified as no explicit login) -->
            <div class="mb-6 text-center pb-4 border-b border-indigo-700">
                <i class="fas fa-user-circle text-5xl text-indigo-300 mb-2"></i>
                <p id="loggedInUserName" class="font-bold text-xl">Admin User</p>
                <p id="userEmail" class="text-sm opacity-80 break-all">admin@example.com</p>
            </div>

            <nav class="flex-grow">
                <ul class="space-y-2">
                    <li>
                        <a href="#" id="nav-dashboard" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-indigo-700 transition duration-200 ease-in-out active-link">
                            <i class="fas fa-tachometer-alt mr-3 text-lg"></i> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#" id="nav-members" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-indigo-700 transition duration-200 ease-in-out">
                            <i class="fas fa-users mr-3 text-lg"></i> Members
                        </a>
                    </li>
                    <li>
                        <a href="#" id="nav-analyzing" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-indigo-700 transition duration-200 ease-in-out">
                            <i class="fas fa-chart-line mr-3 text-lg"></i> Analyzing
                        </a>
                    </li>
                    <li>
                        <a href="#" id="nav-settings" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-indigo-700 transition duration-200 ease-in-out">
                            <i class="fas fa-cog mr-3 text-lg"></i> Settings
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Theme Toggle & Logout -->
            <div class="mt-auto pt-6 border-t border-indigo-700 space-y-4">
                <!-- Theme Toggle -->
                <button id="themeToggleButton" class="w-full flex items-center justify-center px-4 py-3 rounded-lg bg-indigo-700 hover:bg-indigo-600 transition duration-200 ease-in-out text-white font-medium shadow-md">
                    <i class="fas fa-moon mr-2 text-lg"></i> Toggle Dark Mode
                </button>
                <!-- Logout Button (will now just refresh or clear data if no auth) -->
                <button id="logoutButton" class="w-full flex items-center justify-center px-4 py-3 rounded-lg bg-red-600 hover:bg-red-700 transition duration-200 ease-in-out text-white font-medium shadow-md">
                    <i class="fas fa-sign-out-alt mr-2 text-lg"></i> Logout
                </button>
            </div>
            <div class="mt-6 text-sm text-center opacity-75">
                <p>&copy; 2025 Church App</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-grow p-8">
            <div class="max-w-6xl w-full bg-white shadow-lg rounded-2xl p-8 space-y-8 mx-auto">
                <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-8 tracking-wide">Church Admin Panel</h1>

                <!-- User ID Display (Simplified as no explicit login) -->
                <div class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-lg mb-6 shadow-sm" role="alert">
                    <p class="font-bold">Current User ID:</p>
                    <p id="userIdDisplay" class="text-sm break-all">default-admin-id</p>
                </div>

                <!-- Dashboard Section -->
                <div id="dashboardSection" class="content-section active">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                        <!-- Total Members Card -->
                        <div class="bg-blue-600 text-white p-8 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold mb-2">Total Members</h3>
                                <p id="totalMembers" class="text-4xl font-extrabold">0</p>
                            </div>
                            <i class="fas fa-users text-6xl opacity-60"></i>
                        </div>

                        <!-- Active Members Card -->
                        <div class="bg-green-600 text-white p-8 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold mb-2">Active Members</h3>
                                <p id="activeMembers" class="text-4xl font-extrabold">0</p>
                            </div>
                            <i class="fas fa-user-check text-6xl opacity-60"></i>
                        </div>

                        <!-- Visitors Card -->
                        <div class="bg-yellow-600 text-white p-8 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold mb-2">Visitors</h3>
                                <p id="visitors" class="text-4xl font-extrabold">0</p>
                            </div>
                            <i class="fas fa-user-friends text-6xl opacity-60"></i>
                        </div>

                        <!-- Upcoming Events Card -->
                        <div class="lg:col-span-2 bg-gray-50 p-8 rounded-xl shadow-inner">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Upcoming Events</h3>
                            <ul id="upcomingEventsList" class="space-y-4">
                                <!-- Events will be loaded here -->
                                <li class="flex items-center text-gray-700">
                                    <i class="far fa-calendar-alt mr-4 text-indigo-500 text-xl"></i>
                                    <span class="font-medium">July 20, 2025:</span> Youth Fellowship (7:00 PM)
                                </li>
                                <li class="flex items-center text-gray-700">
                                    <i class="far fa-calendar-alt mr-4 text-indigo-500 text-xl"></i>
                                    <span class="font-medium">July 25, 2025:</span> Community Outreach Program (9:00 AM)
                                </li>
                                <li class="flex items-center text-gray-700">
                                    <i class="far fa-calendar-alt mr-4 text-indigo-500 text-xl"></i>
                                    <span class="font-medium">August 3, 2025:</span> Sunday Service (10:00 AM)
                                </li>
                            </ul>
                            <p id="noUpcomingEvents" class="hidden text-gray-600 mt-4">No upcoming events planned.</p>
                        </div>

                        <!-- Recent Activities Card -->
                        <div class="bg-gray-50 p-8 rounded-xl shadow-inner">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Recent Activities</h3>
                            <ul id="recentActivitiesList" class="space-y-4">
                                <!-- Activities will be loaded here -->
                                <li class="flex items-center text-gray-700">
                                    <i class="fas fa-clipboard-list mr-4 text-purple-500 text-xl"></i>
                                    Member "John Doe" added.
                                    <span class="ml-auto text-xs text-gray-500">2 hours ago</span>
                                </li>
                                <li class="flex items-center text-gray-700">
                                    <i class="fas fa-clipboard-list mr-4 text-purple-500 text-xl"></i>
                                    "Jane Smith" status updated to Active.
                                    <span class="ml-auto text-xs text-gray-500">1 day ago</span>
                                </li>
                                <li class="flex items-center text-gray-700">
                                    <i class="fas fa-clipboard-list mr-4 text-purple-500 text-xl"></i>
                                    New visitor "Mike Johnson" recorded.
                                    <span class="ml-auto text-xs text-gray-500">3 days ago</span>
                                </li>
                            </ul>
                            <p id="noRecentActivities" class="hidden text-gray-600 mt-4">No recent activities to display.</p>
                        </div>

                        <!-- Quick Statistics Chart Placeholder -->
                        <div class="lg:col-span-3 bg-gray-50 p-8 rounded-xl shadow-inner">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Membership Growth (Placeholder)</h3>
                            <div class="bg-gray-200 h-48 rounded-lg flex items-center justify-center text-gray-500 text-lg font-medium">
                                Chart Area (e.g., Bar Chart, Line Graph)
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Members Section -->
                <div id="membersSection" class="content-section">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Member Management</h2>

                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                        <!-- Search Bar (Left Top) -->
                        <div class="w-full sm:w-1/2 relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="memberSearch" placeholder="Search by name or status..."
                                   class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm form-input-professional">
                        </div>

                        <!-- Add Member Button (Right Top) -->
                        <button id="addMemberButton"
                                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                            <i class="fas fa-plus mr-2"></i> Add Member
                        </button>
                    </div>

                    <!-- Member List Table -->
                    <div class="bg-gray-50 p-8 rounded-xl shadow-inner">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-6">Church Members</h3>
                        <div class="overflow-x-auto rounded-lg shadow-md">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Facebook</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telegram</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Emergency Call</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="memberList" class="bg-white divide-y divide-gray-200">
                                    <!-- Member rows will be inserted here by JavaScript -->
                                    <tr>
                                        <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Loading members...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="noMembersMessage" class="hidden mt-4 text-center text-gray-600">No members found. Add a new member above!</div>
                    </div>
                </div>

                <!-- Analyzing Section -->
                <div id="analyzingSection" class="content-section">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Data Analysis & Reports</h2>
                    <div class="bg-gray-50 p-8 rounded-xl shadow-inner">
                        <p class="text-gray-700">This section will be dedicated to displaying various analytical reports and insights about your church members.</p>
                        <p class="text-gray-600 mt-2">Examples: Member demographics, attendance trends, giving patterns, etc.</p>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="content-section">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Application Settings</h2>
                    <div class="bg-gray-50 p-8 rounded-xl shadow-inner">
                        <p class="text-gray-700">Manage application settings, user permissions, and other configurations here.</p>
                        <p class="text-gray-600 mt-2">Examples: Notification preferences, data export options, user roles.</p>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Add/Edit Member Modal -->
    <div id="addEditMemberModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="closeAddEditModal">&times;</button>
            <h3 class="text-2xl font-semibold text-gray-800 mb-6" id="modalTitle">Add New Member</h3>
            <form id="addMemberForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                    <input type="text" id="lastName" name="lastName" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm form-input-professional">
                </div>
                <div>
                    <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                    <input type="text" id="firstName" name="firstName" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm form-input-professional">
                </div>
                <div>
                    <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                    <select id="gender" name="gender" required
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm form-input-professional">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status" name="status" required
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm form-input-professional">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Visitor">Visitor</option>
                    </select>
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <input type="tel" id="phone" name="phone"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm form-input-professional" placeholder="+1234567890">
                </div>
                <div>
                    <label for="facebook" class="block text-sm font-medium text-gray-700 mb-1">Facebook Profile</label>
                    <input type="text" id="facebook" name="facebook"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm form-input-professional" placeholder="facebook.com/username">
                </div>
                <div>
                    <label for="telegram" class="block text-sm font-medium text-gray-700 mb-1">Telegram Username</label>
                    <input type="text" id="telegram" name="telegram"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm form-input-professional" placeholder="@username">
                </div>
                <div>
                    <label for="emergencyCall" class="block text-sm font-medium text-gray-700 mb-1">Emergency Call</label>
                    <input type="tel" id="emergencyCall" name="emergencyCall"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm form-input-professional" placeholder="+1234567890 (Emergency)">
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                        <i class="fas fa-plus mr-2"></i> Add Member
                    </button>
                </div>
            </form>
            <div id="formMessage" class="mt-4 text-center text-sm font-medium text-red-600 hidden"></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Confirm Deletion</h3>
            <p class="text-gray-700 mb-6">Are you sure you want to delete this member?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDelete" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Removed explicit email/password auth
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config (provided by the environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // initialAuthToken is no longer directly used for explicit login, but kept for consistency if needed for anonymous sign-in
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db; // Firestore instance
        let auth;
        let currentUserId = null;
        let isAuthReady = false; // Flag to ensure Firebase operations wait for auth
        let allMembers = []; // Store all members for client-side filtering

        // --- Dashboard Layout DOM Elements ---
        const dashboardLayout = document.getElementById('dashboardLayout');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loggedInUserName = document.getElementById('loggedInUserName');
        const userEmail = document.getElementById('userEmail');
        const logoutButton = document.getElementById('logoutButton');
        const themeToggleButton = document.getElementById('themeToggleButton');

        // Dashboard specific elements
        const totalMembersEl = document.getElementById('totalMembers');
        const activeMembersEl = document.getElementById('activeMembers');
        const visitorsEl = document.getElementById('visitors');
        const upcomingEventsList = document.getElementById('upcomingEventsList');
        const recentActivitiesList = document.getElementById('recentActivitiesList');

        // Member Management specific elements
        const addMemberButton = document.getElementById('addMemberButton'); // New button to open modal
        const addEditMemberModal = document.getElementById('addEditMemberModal'); // The modal container
        const closeAddEditModalButton = document.getElementById('closeAddEditModal'); // Button to close modal
        const modalTitle = document.getElementById('modalTitle'); // Title of the modal (Add/Edit)

        const addMemberForm = document.getElementById('addMemberForm'); // The form itself (now inside modal)
        const memberListTableBody = document.getElementById('memberList');
        const noMembersMessage = document.getElementById('noMembersMessage');
        const formMessage = document.getElementById('formMessage'); // Message for form (inside modal)
        const memberSearchInput = document.getElementById('memberSearch');

        // Modal elements for member deletion
        const confirmationModal = document.getElementById('confirmationModal');
        const cancelDeleteButton = document.getElementById('cancelDelete');
        const confirmDeleteButton = document.getElementById('confirmDelete');
        let memberToDeleteId = null; // To store the ID of the member to be deleted

        // Navigation and content section elements
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');

        /**
         * Initializes Firebase and sets up anonymous authentication.
         * The dashboard will now be directly accessible.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app); // Initialize Firestore
                auth = getAuth(app);

                // Sign in anonymously to get a user ID for Firestore operations
                // This ensures there's always an authenticated user for security rules
                // but doesn't require explicit login forms.
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        loggedInUserName.textContent = "Admin User"; // Default name as no explicit login
                        userEmail.textContent = "admin@example.com"; // Default email
                        console.log("User authenticated anonymously:", currentUserId);
                    } else {
                        try {
                            // If no user, sign in anonymously
                            await signInAnonymously(auth);
                            currentUserId = auth.currentUser?.uid || 'default-admin-id'; // Fallback
                            userIdDisplay.textContent = currentUserId;
                            loggedInUserName.textContent = "Admin User";
                            userEmail.textContent = "admin@example.com";
                            console.log("Signed in anonymously. User ID:", currentUserId);
                        } catch (error) {
                            console.error("Error during anonymous authentication:", error);
                            userIdDisplay.textContent = "Authentication failed.";
                            loggedInUserName.textContent = "Error";
                            userEmail.textContent = "Please check console.";
                        }
                    }
                    isAuthReady = true; // Set flag once auth state is checked
                    dashboardLayout.classList.remove('hidden'); // Ensure dashboard is visible
                    loadPlaceholderDashboardData(); // Load dashboard data
                    setupRealtimeListener(); // Setup member list listener
                    showSection('dashboardSection'); // Show dashboard by default
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                userIdDisplay.textContent = "Firebase initialization failed.";
                loggedInUserName.textContent = "Error";
                userEmail.textContent = "Please check console.";
                dashboardLayout.classList.add('hidden'); // Hide dashboard if init fails
                alert("Firebase initialization failed. Check console for details.");
            }
        }

        /**
         * Loads placeholder data for the dashboard elements.
         * In a real application, this would fetch data from Firestore.
         */
        function loadPlaceholderDashboardData() {
            // Placeholder data for demonstration
            totalMembersEl.textContent = '150';
            activeMembersEl.textContent = '120';
            visitorsEl.textContent = '30';

            // Events and activities are already hardcoded in HTML for this UI rebuild
            // In a real app, you'd populate these lists dynamically
        }

        /**
         * Sets up a real-time listener for the 'members' collection in Firestore.
         * Updates the UI whenever there are changes in the database.
         */
        function setupRealtimeListener() {
            if (!db || !currentUserId || !isAuthReady) {
                console.log("Firestore not ready or user not authenticated. Skipping member list listener setup.");
                return;
            }

            // Define the collection path for public data
            const membersCollectionRef = collection(db, `artifacts/${appId}/public/data/members`);

            // Use onSnapshot to listen for real-time updates
            onSnapshot(membersCollectionRef, (snapshot) => {
                allMembers = []; // Clear and repopulate allMembers array
                snapshot.forEach(doc => {
                    allMembers.push({ id: doc.id, ...doc.data() });
                });

                // Sort members by last name then first name for consistent display (in-memory sorting)
                allMembers.sort((a, b) => {
                    const lastNameCompare = (a.lastName || '').localeCompare(b.lastName || '');
                    if (lastNameCompare !== 0) return lastNameCompare;
                    return (a.firstName || '').localeCompare(b.firstName || '');
                });

                // Apply current search filter
                filterAndDisplayMembers();

            }, (error) => {
                console.error("Error fetching members:", error);
                memberListTableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-sm text-red-500">Error loading members. Please try again.</td></tr>`;
            });
        }

        /**
         * Filters the allMembers array based on the search input and displays them.
         */
        function filterAndDisplayMembers() {
            const searchTerm = memberSearchInput.value.toLowerCase().trim();
            let filteredMembers = allMembers;

            if (searchTerm) {
                filteredMembers = allMembers.filter(member =>
                    (member.firstName && member.firstName.toLowerCase().includes(searchTerm)) ||
                    (member.lastName && member.lastName.toLowerCase().includes(searchTerm)) ||
                    (member.gender && member.gender.toLowerCase().includes(searchTerm)) ||
                    (member.status && member.status.toLowerCase().includes(searchTerm)) ||
                    (member.phone && member.phone.toLowerCase().includes(searchTerm)) ||
                    (member.facebook && member.facebook.toLowerCase().includes(searchTerm)) ||
                    (member.telegram && member.telegram.toLowerCase().includes(searchTerm)) ||
                    (member.emergencyCall && member.emergencyCall.toLowerCase().includes(searchTerm))
                );
            }

            memberListTableBody.innerHTML = ''; // Clear existing members
            if (filteredMembers.length === 0) {
                noMembersMessage.classList.remove('hidden');
                memberListTableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">No members found matching your search.</td></tr>`;
            } else {
                noMembersMessage.classList.add('hidden');
                filteredMembers.forEach(member => {
                    displayMember(member);
                });
            }
        }


        /**
         * Displays a single member's data in the table.
         * @param {Object} member - The member object from Firestore.
         */
        function displayMember(member) {
            const row = document.createElement('tr');
            row.id = `member-${member.id}`;
            row.classList.add('hover:bg-gray-50');

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.lastName || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.firstName || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.gender || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.status || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.phone || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.facebook || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.telegram || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.emergencyCall || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button data-id="${member.id}" class="edit-btn text-indigo-600 hover:text-indigo-900 mr-3 p-1 rounded-md hover:bg-gray-200 transition duration-150 ease-in-out">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button data-id="${member.id}" class="delete-btn text-red-600 hover:text-red-900 p-1 rounded-md hover:bg-gray-200 transition duration-150 ease-in-out">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </td>
            `;
            memberListTableBody.appendChild(row);

            // Add event listeners for edit and delete buttons
            row.querySelector('.edit-btn').addEventListener('click', () => editMember(member.id, member));
            row.querySelector('.delete-btn').addEventListener('click', () => showDeleteConfirmation(member.id));
        }

        /**
         * Handles the submission of the add member form.
         * Adds a new member document to Firestore.
         * @param {Event} event - The form submission event.
         */
        const addMemberHandler = async (event) => {
            event.preventDefault();

            if (!db || !currentUserId || !isAuthReady) {
                displayFormMessage("System not ready. Please wait for initialization.", true);
                return;
            }

            const formData = new FormData(addMemberForm);
            const newMember = {
                lastName: formData.get('lastName').trim(),
                firstName: formData.get('firstName').trim(),
                gender: formData.get('gender'),
                status: formData.get('status'),
                phone: formData.get('phone').trim(),
                facebook: formData.get('facebook').trim(),
                telegram: formData.get('telegram').trim(),
                emergencyCall: formData.get('emergencyCall').trim(),
                createdAt: new Date().toISOString() // Timestamp for creation
            };

            // Basic validation
            if (!newMember.lastName || !newMember.firstName || !newMember.gender || !newMember.status) {
                displayFormMessage("Please fill in all required fields (Last Name, First Name, Gender, Status).", true);
                return;
            }

            try {
                // Add a new document to the 'members' collection
                await addDoc(collection(db, `artifacts/${appId}/public/data/members`), newMember);
                addMemberForm.reset(); // Clear the form
                displayFormMessage("Member added successfully!", false);
                hideAddEditModal(); // Hide modal after successful add
            } catch (e) {
                console.error("Error adding document: ", e);
                displayFormMessage("Error adding member. Please try again.", true);
            }
        };
        // Attach the initial add member handler
        addMemberForm.addEventListener('submit', addMemberHandler);

        /**
         * Populates the form with member data for editing.
         * @param {string} memberId - The ID of the member to edit.
         * @param {Object} memberData - The current data of the member.
         */
        function editMember(memberId, memberData) {
            showAddEditModal('Edit Member'); // Show modal with "Edit Member" title
            // Populate the form fields with the member's data
            document.getElementById('lastName').value = memberData.lastName || '';
            document.getElementById('firstName').value = memberData.firstName || '';
            document.getElementById('gender').value = memberData.gender || '';
            document.getElementById('status').value = memberData.status || 'Active';
            document.getElementById('phone').value = memberData.phone || '';
            document.getElementById('facebook').value = memberData.facebook || '';
            document.getElementById('telegram').value = memberData.telegram || '';
            document.getElementById('emergencyCall').value = memberData.emergencyCall || '';

            // Change the form button to "Update Member" and store the memberId
            const submitButton = addMemberForm.querySelector('button[type="submit"]');
            submitButton.innerHTML = '<i class="fas fa-save mr-2"></i> Update Member';
            submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
            submitButton.dataset.editId = memberId; // Store the ID for updating

            // Modify the form's submit event listener temporarily for update
            addMemberForm.removeEventListener('submit', addMemberHandler); // Remove original listener
            addMemberForm.addEventListener('submit', updateMemberHandler); // Add update listener
        }

        /**
         * Handles the update of an existing member in Firestore.
         * @param {Event} event - The form submission event.
         */
        async function updateMemberHandler(event) {
            event.preventDefault();

            if (!db || !currentUserId || !isAuthReady) {
                displayFormMessage("System not ready. Please wait for initialization.", true);
                return;
            }

            const submitButton = addMemberForm.querySelector('button[type="submit"]');
            const memberIdToUpdate = submitButton.dataset.editId;

            if (!memberIdToUpdate) {
                displayFormMessage("Error: Member ID for update not found.", true);
                return;
            }

            const formData = new FormData(addMemberForm);
            const updatedMemberData = {
                lastName: formData.get('lastName').trim(),
                firstName: formData.get('firstName').trim(),
                gender: formData.get('gender'),
                status: formData.get('status'),
                phone: formData.get('phone').trim(),
                facebook: formData.get('facebook').trim(),
                telegram: formData.get('telegram').trim(),
                emergencyCall: formData.get('emergencyCall').trim(),
                updatedAt: new Date().toISOString() // Timestamp for update
            };

            // Basic validation
            if (!updatedMemberData.lastName || !updatedMemberData.firstName || !updatedMemberData.gender || !updatedMemberData.status) {
                displayFormMessage("Please fill in all required fields (Last Name, First Name, Gender, Status).", true);
                return;
            }

            try {
                const memberDocRef = doc(db, `artifacts/${appId}/public/data/members`, memberIdToUpdate);
                await updateDoc(memberDocRef, updatedMemberData);

                displayFormMessage("Member updated successfully!", false);
                resetFormForAdd(); // Reset form back to "Add Member" mode
                hideAddEditModal(); // Hide modal after successful update
            } catch (e) {
                console.error("Error updating document: ", e);
                displayFormMessage("Error updating member. Please try again.", true);
            }
        }

        /**
         * Resets the form to its original "Add Member" state.
         */
        function resetFormForAdd() {
            addMemberForm.reset();
            const submitButton = addMemberForm.querySelector('button[type="submit"]');
            submitButton.innerHTML = '<i class="fas fa-plus mr-2"></i> Add Member';
            submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            delete submitButton.dataset.editId; // Remove the edit ID

            // Revert event listener to addMemberHandler
            addMemberForm.removeEventListener('submit', updateMemberHandler);
            addMemberForm.addEventListener('submit', addMemberHandler);
        }

        /**
         * Shows the confirmation modal for deleting a member.
         * @param {string} id - The ID of the member to be deleted.
         */
        function showDeleteConfirmation(id) {
            memberToDeleteId = id;
            confirmationModal.classList.remove('hidden');
        }

        /**
         * Hides the confirmation modal.
         */
        function hideDeleteConfirmation() {
            memberToDeleteId = null;
            confirmationModal.classList.add('hidden');
        }

        /**
         * Handles the actual deletion of a member from Firestore.
         */
        confirmDeleteButton.addEventListener('click', async () => {
            if (!memberToDeleteId) return;

            if (!db || !currentUserId || !isAuthReady) {
                alert("System not ready. Cannot delete."); // Using alert as formMessage is in modal
                hideDeleteConfirmation();
                return;
            }

            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/members`, memberToDeleteId));
                hideDeleteConfirmation();
                // No need to display form message here, as onSnapshot will update the list
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert("Error deleting member. Please try again."); // Using alert as formMessage is in modal
                hideDeleteConfirmation();
            }
        });

        // Event listener for cancelling deletion
        cancelDeleteButton.addEventListener('click', hideDeleteConfirmation);

        /**
         * Displays a message on the form, either success or error.
         * This message is now specific to the add/edit member form inside the modal.
         * @param {string} message - The message to display.
         * @param {boolean} isError - True if it's an error message, false for success.
         */
        function displayFormMessage(message, isError) {
            formMessage.textContent = message;
            formMessage.classList.remove('hidden', 'text-red-600', 'text-green-600');
            if (isError) {
                formMessage.classList.add('text-red-600');
            } else {
                formMessage.classList.add('text-green-600');
            }
            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 5000); // Hide message after 5 seconds
        }

        /**
         * Shows a specific content section and hides all others.
         * Updates the active state of navigation links.
         * @param {string} sectionId - The ID of the section to show.
         */
        function showSection(sectionId) {
            // Hide all content sections
            contentSections.forEach(section => {
                section.classList.remove('active');
            });

            // Show the selected content section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Update active navigation link styling
            navLinks.forEach(link => {
                link.classList.remove('active-link');
            });
            const activeNavLink = document.getElementById(`nav-${sectionId.replace('Section', '')}`);
            if (activeNavLink) {
                activeNavLink.classList.add('active-link');
            }
        }

        /**
         * Handles the user logout process.
         * Since there's no explicit login, this will simply refresh the page.
         */
        async function handleLogout() {
            // In this version, since there's no explicit login,
            // logging out means simply refreshing the page or clearing local data.
            // If you later re-introduce authentication, this function would call Firebase signOut.
            if (auth && auth.currentUser) {
                try {
                    await auth.signOut();
                    console.log("User signed out.");
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            }
            // For a direct-access dashboard, a refresh effectively "resets" the session
            window.location.reload();
        }

        /**
         * Toggles between light and dark mode.
         */
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            themeToggleButton.innerHTML = isDarkMode ? '<i class="fas fa-sun mr-2"></i> Toggle Light Mode' : '<i class="fas fa-moon mr-2"></i> Toggle Dark Mode';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light'); // Save preference
        }

        // Apply theme preference on load
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleButton.innerHTML = '<i class="fas fa-sun mr-2"></i> Toggle Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggleButton.innerHTML = '<i class="fas fa-moon mr-2"></i> Toggle Dark Mode';
            }
        }

        /**
         * Shows the Add/Edit Member Modal.
         * @param {string} title - The title to display in the modal (e.g., "Add New Member", "Edit Member").
         */
        function showAddEditModal(title = 'Add New Member') {
            modalTitle.textContent = title;
            addEditMemberModal.classList.remove('hidden');
            // Reset form and message when opening for a new add
            if (title === 'Add New Member') {
                resetFormForAdd();
            }
            formMessage.classList.add('hidden'); // Hide previous messages
        }

        /**
         * Hides the Add/Edit Member Modal.
         */
        function hideAddEditModal() {
            addEditMemberModal.classList.add('hidden');
            resetFormForAdd(); // Always reset form when closing
        }


        // Add event listeners
        navLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent default link behavior
                const sectionId = link.id.replace('nav-', '') + 'Section';
                showSection(sectionId);
            });
        });

        logoutButton.addEventListener('click', handleLogout);
        themeToggleButton.addEventListener('click', toggleTheme);
        memberSearchInput.addEventListener('input', filterAndDisplayMembers); // Listen for search input changes

        // Event listeners for the new modal
        addMemberButton.addEventListener('click', () => showAddEditModal('Add New Member'));
        closeAddEditModalButton.addEventListener('click', hideAddEditModal);
        // Close modal if clicked outside (on the overlay)
        addEditMemberModal.addEventListener('click', (event) => {
            if (event.target === addEditMemberModal) {
                hideAddEditModal();
            }
        });


        // Initialize Firebase and apply theme when the window loads
        window.onload = () => {
            applySavedTheme();
            initializeFirebase();
        };
    </script>
</body>
</html>
