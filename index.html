<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Management System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Ensure html and body take full height for min-h-screen to work correctly */
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for modals if content overflows */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark .modal-content::-webkit-scrollbar-track {
            background: #333;
        }
        .dark .modal-content::-webkit-scrollbar-thumb {
            background: #555;
        }
        .dark .modal-content::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold rounded-md px-2 py-1" id="system-name">NewLife Fellowship</h1>
            <nav>
                <ul class="flex space-x-4 items-center">
                    <li>
                        <a href="#" class="hover:text-indigo-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span id="profile-text">Profile</span>
                        </a>
                    </li>
                    <li>
                        <button id="theme-toggle" class="px-2 py-1 rounded-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z" />
                            </svg>
                        </button>
                    </li>
                    <li>
                        <button id="settings-button" class="px-2 py-1 rounded-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span id="settings-text">Settings</span>
                        </button>
                    </li>
                    <li>
                        <a href="#" class="hover:text-indigo-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            <span id="logout-text">Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container mx-auto flex flex-col lg:flex-row mt-8 p-4 lg:p-0 flex-grow">
        <!-- Sidebar -->
        <aside class="w-full lg:w-1/4 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 lg:mr-8 mb-8 lg:mb-0">
            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Navigation</h3>
            <nav>
                <ul>
                    <li class="mb-3">
                        <button id="nav-dashboard" class="w-full text-left px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7-7-7m7 7v10a1 1 0 01-1 1h-3" />
                            </svg>
                            <span id="dashboard-nav-text">Dashboard</span>
                        </button>
                    </li>
                    <li class="mb-3">
                        <button id="nav-members" class="w-full text-left px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h2a2 2 0 002-2V7a2 2 0 00-2-2h-2v12m-2 2h-2a2 2 0 01-2-2V7a2 2 0 012-2h2m-6 0H4a2 2 0 00-2 2v10a2 2 0 002 2h2" />
                            </svg>
                            <span id="members-nav-text">Members</span>
                        </button>
                    </li>
                    <li class="mb-3">
                        <button id="nav-events" class="w-full text-left px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span id="events-nav-text">Events</span>
                        </button>
                    </li>
                    <li class="mb-3">
                        <button id="nav-reports" class="w-full text-left px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-5m3 5v-8m3 5v-2M9 21h6a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span id="reports-nav-text">Reports</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="w-full lg:w-3/4 flex-grow">
            <div id="loading-spinner" class="flex justify-center items-center h-64 hidden">
                <div class="rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 dark:border-indigo-300 animate-spin"></div>
                <p class="ml-4 text-lg text-gray-700 dark:text-gray-300" id="loading-text">Loading...</p>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboard-section" class="p-6 bg-white dark:bg-gray-700 rounded-lg shadow-md text-gray-900 dark:text-gray-100">
                <h2 class="text-2xl font-semibold mb-4" id="dashboard-overview-title">Dashboard Overview</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-4" id="dashboard-welcome-text">Welcome to your Church Management Dashboard! Here you'll find quick summaries and key metrics.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-6">
                    <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-blue-800 dark:text-blue-200" id="total-members-title">Total Members</h3>
                        <p class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-2" id="total-members-count">0</p>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-purple-800 dark:text-purple-200" id="active-members-title">Active Members</h3>
                        <p class="text-3xl font-bold text-purple-600 dark:text-purple-400 mt-2" id="active-members-count">0</p>
                    </div>
                    <div class="bg-pink-50 dark:bg-pink-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-pink-800 dark:text-pink-200" id="new-believers-title">New Believers</h3>
                        <p class="text-3xl font-bold text-pink-600 dark:text-pink-400 mt-2" id="new-believers-count">0</p>
                    </div>
                    <div class="bg-indigo-50 dark:bg-indigo-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-indigo-800 dark:text-indigo-200" id="service1-members-title">Service 1 Members</h3>
                        <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mt-2" id="service1-members-count">0</p>
                    </div>
                    <div class="bg-teal-50 dark:bg-teal-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-teal-800 dark:text-teal-200" id="service2-members-title">Service 2 Members</h3>
                        <p class="text-3xl font-bold text-teal-600 dark:text-teal-400 mt-2" id="service2-members-count">0</p>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-green-800 dark:text-green-200" id="upcoming-events-title">Upcoming Events</h3>
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400 mt-2" id="upcoming-events-count">0</p>
                    </div>
                </div>
                <div class="mt-6 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="text-xl font-semibold mb-2" id="quick-actions-title">Quick Actions</h3>
                    <ul class="list-disc list-inside mt-2 text-gray-700 dark:text-gray-200">
                        <li><button id="add-new-member-dashboard-btn" class="text-indigo-600 dark:text-indigo-400 hover:underline">Add New Member</button></li>
                        <li><button id="create-new-event-dashboard-btn" class="text-indigo-600 dark:text-indigo-400 hover:underline">Create New Event</button></li>
                    </ul>
                </div>
            </section>

            <!-- Members Section -->
            <section id="members-section" class="p-6 bg-white dark:bg-gray-700 rounded-lg shadow-md text-gray-900 dark:text-gray-100 hidden">
                <h2 class="text-2xl font-semibold mb-4" id="members-list-title">Members List</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-4" id="manage-members-text">Display and manage church members here. Search for members by name or gender.</p>

                <!-- Action buttons: Add New Member, Import, and Export buttons -->
                <div class="flex flex-col sm:flex-row justify-end items-center gap-4 mb-4 flex-wrap">
                    <label for="importExcel" class="px-4 py-2 text-sm bg-gray-200 text-gray-800 rounded-lg shadow-md hover:bg-gray-300 hover:shadow-lg cursor-pointer text-center dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500 transition duration-200 ease-in-out">
                        <span id="import-excel-text">Import Excel</span>
                        <input type="file" id="importExcel" accept=".xlsx, .xls" class="hidden" />
                    </label>
                    <button id="export-excel-btn" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-200 ease-in-out">Export as Excel</button>
                    <button id="add-new-member-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out">Add New Member</button>
                </div>

                <!-- Member controls: Filters, Search -->
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 flex-wrap">
                    <!-- Left side: Filters -->
                    <div class="flex flex-col sm:flex-row gap-4 items-center">
                        <select id="status-filter-select" class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                            <option value="All" id="status-all">Show All</option>
                            <option value="Active" id="status-active">Active</option>
                            <option value="Inactive" id="status-inactive">Inactive</option>
                            <option value="Cell group" id="status-cellgroup">Cell group</option>
                            <option value="Parth-Way" id="status-parthway">Parth-Way</option>
                            <option value="New believer" id="status-newbeliever">New believer</option>
                            <option value="Visitor" id="status-visitor">Visitor</option>
                        </select>
                        <select id="members-per-page-select" class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                            <option value="5">Show 5</option>
                            <option value="10">Show 10</option>
                            <option value="20">Show 20</option>
                            <option value="50">Show 50</option>
                            <option value="100">Show 100</option>
                            <option value="all">Show All</option>
                        </select>
                    </div>
                    <!-- Right side: Search -->
                    <div class="flex flex-col sm:flex-row gap-4 items-center">
                        <input type="text" id="member-search-input" placeholder="Search members..." class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out" />
                        <button id="execute-search-button" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out">Search</button>
                    </div>
                </div>

                <div class="overflow-x-auto border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="table-photo-header">Photo</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="table-name-header">Name</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="table-gender-header">Gender</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="table-phone-header">Phone</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="table-status-header">Status</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="table-actions-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="members-table-body" class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                            <!-- Member rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <nav class="mt-4 flex justify-center hidden" aria-label="Pagination" id="members-pagination">
                    <ul class="flex items-center -space-x-px">
                        <li>
                            <button id="prev-page-btn" class="px-3 py-2 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out">Previous</button>
                        </li>
                        <div id="pagination-numbers" class="flex">
                            <!-- Page numbers will be inserted here by JavaScript -->
                        </div>
                        <li>
                            <button id="next-page-btn" class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out">Next</button>
                        </li>
                    </ul>
                </nav>
            </section>

            <!-- Events Section -->
            <section id="events-section" class="p-6 bg-white dark:bg-gray-700 rounded-lg shadow-md text-gray-900 dark:text-gray-100 hidden">
                <h2 class="text-2xl font-semibold mb-4" id="events-management-title">Events Management</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-4" id="plan-track-events-text">Plan and track church events. This could include calendars, event registration, and attendance tracking.</p>

                <button id="create-new-event-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out mb-6">Create New Event</button>

                <div class="overflow-x-auto border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="event-name-header">Event Name</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="event-date-header">Date</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="event-time-header">Time</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="event-location-header">Location</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="event-service-header">Service</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="event-team-header">Team</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="event-description-header">Description</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" id="event-actions-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="events-table-body" class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                            <!-- Event rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports-section" class="p-6 bg-white dark:bg-gray-700 rounded-lg shadow-md text-gray-900 dark:text-gray-100 hidden">
                <h2 class="text-2xl font-semibold mb-4" id="reports-analytics-title">Reports & Analytics</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-4" id="generate-reports-text">Generate reports on membership, attendance, donations, and more.</p>
                <div class="mt-6 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <label for="report-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" id="select-report-label">Select a report to generate:</label>
                    <select id="report-select" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" id="select-report-placeholder">-- Select a report to generate --</option>
                        <option value="Membership Growth Report" id="report-membership-growth">Membership Growth Report</option>
                        <option value="Event Attendance Report" id="report-event-attendance">Event Attendance Report</option>
                        <option value="Financial Summary Report" id="report-financial-summary">Financial Summary Report</option>
                        <option value="Monthly Membership Comparison" id="report-monthly-comparison">Monthly Membership Comparison Report</option>
                    </select>
                    <button id="generate-report-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 hover:shadow-lg mt-6 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out" disabled>Generate Report</button>
                </div>
                <div id="generated-report-area" class="mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600 hidden">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4" id="generated-report-title"></h3>
                    <div id="generated-report-content" class="overflow-x-auto">
                        <!-- Report content will be inserted here by JavaScript -->
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="p-6 bg-white dark:bg-gray-700 rounded-lg shadow-md text-gray-900 dark:text-gray-100 hidden">
                <h2 class="text-2xl font-semibold mb-4" id="settings-title">Settings</h2>
                <div class="mt-6 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="text-xl font-semibold mb-2" id="language-setting-title">Language</h3>
                    <div class="flex items-center gap-4">
                        <label for="language-select-setting" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="language-label">Language:</label>
                        <select id="language-select-setting" class="mt-1 block w-auto p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="en" id="lang-en">English</option>
                            <option value="km" id="lang-km">Khmer</option>
                        </select>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Member Modal -->
    <div id="member-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-75 hidden">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <h3 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-6 border-b pb-3 border-gray-200 dark:border-gray-600" id="member-modal-title">Add Member</h3>
            <form id="member-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2 flex flex-col items-center mb-4">
                    <label for="member-photo-upload" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" id="profile-photo-label">Profile Photo</label>
                    <div class="relative w-24 h-24 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                        <img id="photo-preview" src="" alt="Profile" class="w-full h-full object-cover max-w-full hidden" />
                        <svg id="photo-placeholder" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <input type="file" id="member-photo-upload" name="photo" accept="image/*" class="mt-3 text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                </div>

                <div>
                    <label for="member-firstName" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="first-name-label">First Name</label>
                    <input type="text" id="member-firstName" name="firstName" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="member-lastName" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="last-name-label">Last Name</label>
                    <input type="text" id="member-lastName" name="lastName" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="member-gender" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="gender-label">Gender</label>
                    <select id="member-gender" name="gender" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="" id="select-gender-placeholder">Select Gender</option>
                        <option value="Male" id="gender-male">Male</option>
                        <option value="Female" id="gender-female">Female</option>
                        <option value="Other" id="gender-other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="member-dateOfBirth" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="dob-label">Date of Birth</label>
                    <input type="date" id="member-dateOfBirth" name="dateOfBirth" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="member-memberClass" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="member-class-label">Class</label>
                    <select id="member-memberClass" name="memberClass" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Class</option>
                        <option value="Life Guidance Class">Life Guidance Class</option>
                        <option value="Changing Life">Changing Life</option>
                        <option value="Discipleship">Discipleship</option>
                        <option value="Serving Class">Serving Class</option>
                        <option value="SOM">SOM</option>
                        <option value="Leadership">Leadership</option>
                    </select>
                </div>
                <div>
                    <label for="member-statue" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="statue-label">Statue</label>
                    <select id="member-statue" name="statue" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" id="select-statue-placeholder">Select Statue</option>
                        <option value="Done" id="statue-done">Done</option>
                        <option value="Not yet" id="statue-not-yet">Not yet</option>
                    </select>
                </div>
                <div>
                    <label for="member-from" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="from-label">From (Address/Origin)</label>
                    <input type="text" id="member-from" name="from" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="member-service" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="service-label">Service (e.g., Choir, Usher)</label>
                    <select id="member-service" name="service" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" id="select-service-placeholder">Select Service</option>
                        <option value="Service 1">Service 1</option>
                        <option value="Service 2">Service 2</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="member-phoneNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="phone-number-label">Phone Number</label>
                    <input type="tel" id="member-phoneNumber" name="phoneNumber" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="member-emergencyNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="emergency-number-label">Emergency Number</label>
                    <input type="tel" id="member-emergencyNumber" name="emergencyNumber" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="member-facebook" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="facebook-profile-label">Facebook Profile</label>
                    <input type="text" id="member-facebook" name="facebook" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., facebook.com/yourprofile" />
                </div>
                <div>
                    <label for="member-telegram" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="telegram-id-label">Telegram ID</label>
                    <input type="text" id="member-telegram" name="telegram" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., @yourtelegramid" />
                </div>
                <div>
                    <label for="member-temperature" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="temperature-label">Temperature (Â°C)</label>
                    <input type="number" step="0.1" id="member-temperature" name="temperature" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 36.5" />
                </div>
                <div class="col-span-1 md:col-span-2 flex justify-end space-x-3 mt-4">
                    <button type="button" id="member-modal-cancel-btn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">Cancel</button>
                    <button type="submit" id="member-modal-save-btn" class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Member Details Modal -->
    <div id="member-details-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-75 hidden">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <h3 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-6 border-b pb-3 border-gray-200 dark:border-gray-600" id="member-details-modal-title">Member Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="member-details-content">
                <!-- Details populated by JS -->
            </div>
            <div class="flex justify-end mt-6">
                <button id="member-details-close-btn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">Close</button>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-75 hidden">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <h3 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-6 border-b pb-3 border-gray-200 dark:border-gray-600" id="event-modal-title">Add Event</h3>
            <form id="event-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="event-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="event-name-label">Event Name</label>
                    <input type="text" id="event-name" name="name" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="event-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="event-date-label">Date</label>
                    <input type="date" id="event-date" name="date" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="event-time" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="event-time-label">Time</label>
                    <input type="time" id="event-time" name="time" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="event-location" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="event-location-label">Location</label>
                    <select id="event-location" name="location" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="">Select Location</option>
                        <option value="Tual Sangkae">Tual Sangkae</option>
                        <option value="Stueng Meanchey">Stueng Meanchey</option>
                        <option value="Main Hall">Main Hall</option>
                        <option value="Youth Room">Youth Room</option>
                        <option value="City Park">City Park</option>
                        <option value="Sanctuary">Sanctuary</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="event-service" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="event-service-label">Service</label>
                    <select id="event-service" name="service" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Service</option>
                        <option value="Service 1">Service 1</option>
                        <option value="Service 2">Service 2</option>
                        <option value="Worship">Worship</option>
                        <option value="Youth Ministry">Youth Ministry</option>
                        <option value="Community Service">Community Service</option>
                        <option value="Prayer Ministry">Prayer Ministry</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="event-team" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="event-team-label">Team</label>
                    <select id="event-team" name="team" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Team</option>
                        <option value="Dynamic">Dynamic</option>
                        <option value="Static">Static</option>
                        <option value="Pastoral Team">Pastoral Team</option>
                        <option value="Youth Leaders">Youth Leaders</option>
                        <option value="Outreach Team">Outreach Team</option>
                        <option value="Prayer Warriors">Prayer Warriors</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="event-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="event-description-label">Description</label>
                    <textarea id="event-description" name="description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2 flex justify-end space-x-3 mt-4">
                    <button type="button" id="event-modal-cancel-btn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">Cancel</button>
                    <button type="submit" id="event-modal-save-btn" class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photo-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-75 hidden">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-4 max-w-lg max-h-[90vh] overflow-y-auto modal-content">
            <button id="photo-modal-close-btn" class="absolute top-3 right-3 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white text-2xl font-bold focus:outline-none">
                &times;
            </button>
            <img id="photo-modal-image" src="" alt="Enlarged Member Photo" class="max-w-full h-auto rounded-lg" />
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-75 hidden">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md modal-content">
            <h3 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-4" id="delete-confirm-modal-title">Confirm Deletion</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-6" id="delete-confirmation-text">Are you sure you want to delete this member? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="delete-cancel-btn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">Cancel</button>
                <button type="submit" id="delete-confirm-btn" class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-200 ease-in-out">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global App State
        const appState = {
            db: null,
            auth: null,
            userId: null,
            isAuthReady: false,
            privateCollectionPath: null,
            activeSection: 'dashboard',
            theme: 'light',
            language: 'en',
            isLoading: true,
            members: [], // This will be populated by Firestore
            events: [],
            editingMember: null,
            selectedMember: null,
            memberToDelete: null,
            editingEvent: null,
            memberSearchQuery: '',
            appliedSearchQuery: '',
            statusFilter: 'All',
            membersPerPage: 10,
            currentPage: 1,
            monthlyMembershipData: [
                { month: 'Jan 2025', totalMembers: 150, newMembers: 10, activeMembers: 140 },
                { month: 'Feb 2025', totalMembers: 155, newMembers: 8, activeMembers: 145 },
                { month: 'Mar 2025', totalMembers: 160, newMembers: 12, activeMembers: 150 },
                { month: 'Apr 2025', totalMembers: 162, newMembers: 5, activeMembers: 155 },
                { month: 'May 2025', totalMembers: 168, newMembers: 10, activeMembers: 160 },
                { month: 'Jun 2025', totalMembers: 175, newMembers: 15, activeMembers: 165 },
                { month: 'Jul 2025', totalMembers: 180, newMembers: 10, activeMembers: 170 },
            ],
            hasCheckedForInitialMembers: false, // New flag to track initial member data check
            translations: {
                en: {
                    dashboard: 'Dashboard',
                    dashboardOverview: 'Dashboard Overview',
                    welcomeDashboard: 'Welcome to your Church Management Dashboard! Here you\'ll find quick summaries and key metrics.',
                    totalMembers: 'Total Members',
                    activeMembers: 'Active Members',
                    newBelievers: 'New Believers',
                    service1Members: 'Service 1 Members',
                    service2Members: 'Service 2 Members',
                    upcomingEvents: 'Upcoming Events',
                    recentDonations: 'Recent Donations',
                    quickActions: 'Quick Actions',
                    addNewMember: 'Add New Member',
                    createNewEvent: 'Create New Event',
                    recordDonation: 'Record Donation',
                    members: 'Members',
                    membersList: 'Members List',
                    manageMembers: 'Display and manage church members here. Search for members by name or gender.',
                    searchMembers: 'Search members...',
                    allStatuses: 'Show All',
                    active: 'Active',
                    inactive: 'Inactive',
                    serving: 'Serving',
                    cellGroup: 'Cell group',
                    parthWay: 'Parth-Way',
                    newBeliever: 'New believer',
                    visitor: 'Visitor',
                    baptized: 'Baptized',
                    notYetBaptized: 'Not yet baptized',
                    show: 'Show',
                    importExcel: 'Import Excel',
                    exportExcel: 'Export as Excel',
                    exportPdf: 'Export as PDF',
                    photo: 'Photo',
                    name: 'Name',
                    gender: 'Gender',
                    phone: 'Phone',
                    status: 'Status',
                    actions: 'Actions',
                    noMembersFound: 'No members found.',
                    previous: 'Previous',
                    next: 'Next',
                    events: 'Events',
                    eventsManagement: 'Events Management',
                    planTrackEvents: 'Plan and track church events. This could include calendars, event registration, and attendance tracking.',
                    upcomingEventsList: 'Upcoming events will be listed here...',
                    sundayService: 'Sunday Service',
                    youthGroupMeeting: 'Youth Group Meeting',
                    communityOutreach: 'Community Outreach',
                    reports: 'Reports',
                    reportsAnalytics: 'Reports & Analytics',
                    generateReports: 'Generate reports on membership, attendance, donations, and more.',
                    selectReport: 'Select a report to generate:',
                    membershipGrowthReport: 'Membership Growth Report',
                    eventAttendanceReport: 'Event Attendance Report',
                    financialSummaryReport: 'Financial Summary Report',
                    monthlyComparisonReport: 'Monthly Membership Comparison Report',
                    generateReport: 'Generate Report',
                    profile: 'Profile',
                    settings: 'Settings',
                    logout: 'Logout',
                    loading: 'Loading...',
                    editMember: 'Edit Member',
                    addMember: 'Add Member',
                    profilePhoto: 'Profile Photo',
                    firstName: 'First Name',
                    lastName: 'Last Name',
                    selectGender: 'Select Gender',
                    dateOfBirth: 'Date of Birth',
                    memberClass: 'Class',
                    fromAddressOrigin: 'From (Address/Origin)',
                    serviceEg: 'Service (e.g., Choir, Usher)',
                    selectService: 'Select Service',
                    phoneNumber: 'Phone Number',
                    emergencyNumber: 'Emergency Number',
                    facebookProfile: 'Facebook Profile',
                    telegramID: 'Telegram ID',
                    cancel: 'Cancel',
                    saveChanges: 'Save Changes',
                    memberDetails: 'Member Details',
                    close: 'Close',
                    confirmDeletion: 'Confirm Deletion',
                    deleteConfirmation: 'Are you sure you want to delete member {memberName}? This action cannot be undone.',
                    delete: 'Delete',
                    language: 'Language',
                    english: 'English',
                    khmer: 'Khmer',
                    eventName: 'Event Name',
                    eventDate: 'Date',
                    eventTime: 'Time',
                    eventLocation: 'Location',
                    eventDescription: 'Description',
                    eventService: 'Service',
                    eventTeam: 'Team',
                    addEvent: 'Add Event',
                    editEvent: 'Edit Event',
                    noEventsFound: 'No events found.',
                    systemName: 'NewLife Fellowship',
                    reportTitleMonthlyComparison: 'Monthly Membership Comparison',
                    reportMonth: 'Month',
                    reportTotalMembers: 'Total Members',
                    reportNewMembers: 'New Members',
                    reportActiveMembers: 'Active Members',
                    search: 'Search',
                    statue: 'Statue',
                    selectStatue: 'Select Statue',
                    done: 'Done',
                    notYet: 'Not yet',
                    temperature: 'Temperature', // New translation key
                },
                km: {
                    dashboard: 'áááá¶ááááááááááá',
                    dashboardOverview: 'áá·ááááá¶ááá¼áááááááá¶ááááááááááá',
                    welcomeDashboard: 'áá¼ááááá¶áááááááá¶áááááá¶ááááááááááááááááá·á á¶áááááá¢ááá! áááá¸áááá¢ááááá¹ááá¾áááááááá¸áááááá áá·áááááá¶áááááá¶áááá',
                    totalMembers: 'ááá¶áá·áááá»á',
                    activeMembers: 'ááá¶áá·áááááá',
                    newBelievers: 'á¢ááááá¿áááá¸',
                    service1Members: 'ááá¶áá·áááááá¾áá¶á á¡',
                    service2Members: 'ááá¶áá·áááááá¾áá¶á á¢',
                    upcomingEvents: 'áááá¹áááá·áá¶ááááá¶ááá»á',
                    recentDonations: 'áá·áá¶ááá¶ááááá¸á',
                    quickActions: 'ááááááá¶ááá áá',
                    addNewMember: 'ááááááááá¶áá·ááááá¸',
                    createNewEvent: 'ááááá¾ááááá¹áááá·áá¶ááááááá¸',
                    recordDonation: 'ááááááá¶áá·áá¶ááá¶á',
                    members: 'ááá¶áá·á',
                    membersList: 'ááááá¸ááá¶áá·á',
                    manageMembers: 'áááá á¶ááá·ááááááááááááá¶áá·ááááááá·á á¶ááááá¸áááá áááááááááá¶áá·ááá¶áááááá á¬áááá',
                    searchMembers: 'áááááááááá¶áá·á...',
                    allStatuses: 'ááááááááá¶ááá¶á',
                    active: 'ááá¶áá·áááááá',
                    inactive: 'ááá¶áá·áá¢ááááá',
                    serving: 'ááááá¾',
                    cellGroup: 'áááá»ááááá»á',
                    parthWay: 'áááá·ááá¶ááááááááá·ááá',
                    newBeliever: 'á¢ááááá¿áááá¸',
                    visitor: 'á¢ááááááá¸',
                    baptized: 'áá¶áâááááá»ááá¹á',
                    notYetBaptized: 'áá·ááá¶ááááááá»ááá¹á',
                    show: 'áááá á¶á',
                    importExcel: 'áá¶ááá¼á Excel',
                    exportExcel: 'áá¶áááááá¶ Excel',
                    exportPdf: 'áá¶áááááá¶ PDF',
                    photo: 'áá¼ááá',
                    name: 'ááááá',
                    gender: 'ááá',
                    phone: 'áá¼áááááá',
                    status: 'áááá¶ááá¶á',
                    actions: 'ááááááá¶á',
                    noMembersFound: 'áááá·ááá¾áááá¶áá·áááá',
                    previous: 'áá»á',
                    next: 'ááááá¶áá',
                    events: 'áááá¹áááá·áá¶ááá',
                    eventsManagement: 'áá¶áááááááááááááá¹áááá·áá¶ááá',
                    planTrackEvents: 'áááááááááá¶á áá·ááá¶ááá¶ááááá¹áááá·áá¶ááááááááá·á á¶áá áááá¢á¶ááá½áááááá¼áááááá·áá·á áá¶ááá»áááááááááá¹áááá·áá¶ááá áá·ááá¶ááá¶ááá¶ááá¶ááá¼ááá½áá',
                    upcomingEventsList: 'áááá¹áááá·áá¶ááááá¶ááá»ááá¹ááááá¼ááá¶ááá»áááááá¸áááá¸ááá...',
                    sundayService: 'áá¶ááááá¶ááááááááááá¢á¶áá·ááá',
                    youthGroupMeeting: 'áá¶áááááá»ááááá»ááá»ááá',
                    communityOutreach: 'áá¶ááá¶áááááá',
                    reports: 'ááá¶ááá¶ááá',
                    reportsAnalytics: 'ááá¶ááá¶ááá áá·ááá¶ááá·áá¶á',
                    generateReports: 'ááááá¾áááá¶ááá¶ááááááá¸áá¸ááá¶áá·ááá¶á áá¶ááá¼ááá½á áá·áá¶ááá¶á áá·ááááá¾ááááá',
                    selectReport: 'áááá¾ááá¾áááá¶ááá¶ááááá¾áááá¸ááááá¾áá',
                    membershipGrowthReport: 'ááá¶ááá¶ááááááá¾áááá¶áá·ááá¶á',
                    eventAttendanceReport: 'ááá¶ááá¶ááááá¶ááá¼ááá½ááááá¹áááá·áá¶ááá',
                    financialSummaryReport: 'ááá¶ááá¶áááááááááá á·ááááááááá»',
                    monthlyComparisonReport: 'ááá¶ááá¶áááááááááááááá¶áá·ááá¶áááááá¶ááá',
                    generateReport: 'ááááá¾áááá¶ááá¶ááá',
                    profile: 'áááááááá·áá¼á',
                    settings: 'áá¶áááááá',
                    logout: 'ááá',
                    loading: 'áááá»ááááá»á...',
                    editMember: 'ááááááá½áááá¶áá·á',
                    addMember: 'ááááááááá¶áá·á',
                    profilePhoto: 'áá¼ááááááááááá·áá¼á',
                    firstName: 'áá¶ááááá½á',
                    lastName: 'ááááá¼á',
                    selectGender: 'áááá¾ááá¾áááá',
                    dateOfBirth: 'áááááááááá¶ááááá¾á',
                    memberClass: 'áááá¶áá',
                    fromAddressOrigin: 'áááá¸ (á¢á¶áááááá¶á/áááá»ááááá¾á)',
                    serviceEg: 'áá¶áááááá¾ (á§áá¶á áááá áááá»ááááááá, á¢áááááááá¾)',
                    selectService: 'áááá¾ááá¾ááá¶áááááá¾',
                    phoneNumber: 'ááááá¼áááááá',
                    emergencyNumber: 'ááááá¼ááááááááááá¶áá',
                    facebookProfile: 'áááááá Facebook',
                    telegramID: 'áááááááá¶áá Telegram',
                    cancel: 'áááááá',
                    saveChanges: 'ááááá¶áá»ááá¶ááááá¶áááááá¼á',
                    memberDetails: 'áááááá¶ááááá¢á·áááá¶áá·á',
                    close: 'áá·á',
                    confirmDeletion: 'ááááá¶áááá¶ááá»á',
                    deleteConfirmation: 'áá¾á¢ááááááá¶áááá¶ááááá»áááá¶áá·á {memberName} áá? ááááááá¶áááááá·áá¢á¶ááááá¡áááá·ááá¶áááá',
                    delete: 'áá»á',
                    language: 'áá¶áá¶',
                    english: 'á¢ááááááá',
                    khmer: 'ááááá',
                    eventName: 'ááááááááá¹áááá·áá¶ááá',
                    eventDate: 'áá¶áááá·ááááá',
                    eventTime: 'áááá',
                    eventLocation: 'áá¸áá¶áá',
                    eventDescription: 'áá¶ááá·ááááá¶',
                    eventService: 'áá¶áááááá¾',
                    eventTeam: 'áááá»á',
                    addEvent: 'áááááááááá¹áááá·áá¶ááá',
                    editEvent: 'ááááááá½ááááá¹áááá·áá¶ááá',
                    noEventsFound: 'áááá·ááá¾ááááá¹áááá·áá¶áááááá',
                    systemName: 'NewLife Fellowship',
                    reportTitleMonthlyComparison: 'Monthly Membership Comparison',
                    reportMonth: 'áá',
                    reportTotalMembers: 'ááá¶áá·áááá»á',
                    reportNewMembers: 'ááá¶áá·ááááá¸',
                    reportActiveMembers: 'ááá¶áá·áááááá',
                    search: 'ááááááá',
                    statue: 'áá¼ááááá¶á',
                    selectStatue: 'áááá¾ááá¾ááá¼ááááá¶á',
                    done: 'áá½ááá¶áá',
                    notYet: 'áá·ááá¶áá',
                    temperature: 'áá¸áá»ááá áá¶á', // New translation key
                },
            }
        };

        // Utility function to get translated text
        function getTranslation(key) {
            const currentLang = appState.translations[appState.language];
            return currentLang[key] || key; // Fallback to key if translation not found
        }

        // --- UI Update Functions ---
        // Moved these functions to the top to ensure they are defined before being called
        function updateUI() {
            updateHeader();
            updateSidebar();
            renderActiveSection();
            updateModals();
            translateElements();
        }

        function translateElements() {
            const elementsToTranslate = {
                'system-name': 'systemName',
                'profile-text': 'profile',
                'settings-text': 'settings',
                'logout-text': 'logout',
                'dashboard-nav-text': 'dashboard',
                'members-nav-text': 'members',
                'events-nav-text': 'events',
                'reports-nav-text': 'reports',
                'loading-text': 'loading',
                'dashboard-overview-title': 'dashboardOverview',
                'dashboard-welcome-text': 'welcomeDashboard',
                'total-members-title': 'totalMembers',
                'active-members-title': 'activeMembers',
                'new-believers-title': 'newBelievers',
                'service1-members-title': 'service1Members',
                'service2-members-title': 'service2Members',
                'upcoming-events-title': 'upcomingEvents',
                'quick-actions-title': 'quickActions',
                'add-new-member-dashboard-btn': 'addNewMember',
                'create-new-event-dashboard-btn': 'createNewEvent',
                'members-list-title': 'membersList',
                'manage-members-text': 'manageMembers',
                'member-search-input': 'searchMembers',
                'execute-search-button': 'search',
                'import-excel-text': 'importExcel',
                'export-excel-btn': 'exportExcel',
                'table-photo-header': 'photo',
                'table-name-header': 'name',
                'table-gender-header': 'gender',
                'table-phone-header': 'phone',
                'table-status-header': 'status',
                'table-actions-header': 'actions',
                'prev-page-btn': 'previous',
                'next-page-btn': 'next',
                'events-management-title': 'eventsManagement',
                'plan-track-events-text': 'planTrackEvents',
                'create-new-event-btn': 'createNewEvent',
                'event-name-header': 'eventName',
                'event-date-header': 'eventDate',
                'event-time-header': 'eventTime',
                'event-location-header': 'eventLocation',
                'event-service-header': 'eventService',
                'event-team-header': 'eventTeam',
                'event-description-header': 'eventDescription',
                'event-actions-header': 'actions',
                'reports-analytics-title': 'reportsAnalytics',
                'generate-reports-text': 'generateReports',
                'select-report-label': 'selectReport',
                'select-report-placeholder': 'selectReport',
                'report-membership-growth': 'membershipGrowthReport',
                'report-event-attendance': 'eventAttendanceReport',
                'report-financial-summary': 'Financial Summary Report',
                'report-monthly-comparison': 'Monthly Membership Comparison Report',
                'generate-report-btn': 'Generate Report',
                'profile': 'profile',
                'settings': 'settings',
                'logout': 'logout',
                'loading': 'loading',
                'editMember': 'editMember',
                'addMember': 'addMember',
                'profilePhoto': 'profilePhoto',
                'firstName': 'firstName',
                'lastName': 'lastName',
                'selectGender': 'selectGender',
                'dateOfBirth': 'dateOfBirth',
                'memberClass': 'memberClass',
                'fromAddressOrigin': 'fromAddressOrigin',
                'serviceEg': 'serviceEg',
                'selectService': 'selectService',
                'phoneNumber': 'phoneNumber',
                'emergencyNumber': 'emergencyNumber',
                'facebookProfile': 'facebookProfile',
                'telegramID': 'telegramID',
                'cancel': 'cancel',
                'saveChanges': 'saveChanges',
                'memberDetails': 'memberDetails',
                'close': 'close',
                'confirmDeletion': 'confirmDeletion',
                'deleteConfirmation': 'deleteConfirmation',
                'delete': 'delete',
                'language': 'Language',
                'english': 'English',
                'khmer': 'Khmer',
                'eventName': 'Event Name',
                'eventDate': 'Date',
                'eventTime': 'Time',
                'eventLocation': 'Location',
                'eventDescription': 'Description',
                'eventService': 'Service',
                'eventTeam': 'Team',
                'addEvent': 'Add Event',
                'editEvent': 'Edit Event',
                'noEventsFound': 'No events found.',
                    'systemName': 'NewLife Fellowship',
                    'reportTitleMonthlyComparison': 'Monthly Membership Comparison',
                    'reportMonth': 'Month',
                    'reportTotalMembers': 'Total Members',
                    'reportNewMembers': 'New Members',
                    'reportActiveMembers': 'Active Members',
                    'search': 'Search',
                    'statue-label': 'statue',
                    'select-statue-placeholder': 'selectStatue',
                    'statue-done': 'done',
                    'statue-not-yet': 'notYet',
                    'temperature-label': 'temperature', // New translation key
            };

            for (const id in elementsToTranslate) {
                const element = document.getElementById(id);
                if (element) {
                    const translationKey = elementsToTranslate[id];
                    if (element.tagName === 'INPUT' && element.placeholder) {
                        element.placeholder = getTranslation(translationKey);
                    } else if (element.tagName === 'OPTION') {
                        // For options, update text content but be careful not to overwrite value
                        element.textContent = getTranslation(translationKey);
                    } else {
                        element.textContent = getTranslation(translationKey);
                    }
                }
            }

            // Handle select options separately for dynamic translation
            const statusSelect = document.getElementById('status-filter-select');
            if (statusSelect) {
                Array.from(statusSelect.options).forEach(option => {
                    // Use a more specific translation key for options if needed, or just their value
                    option.textContent = getTranslation(option.value.toLowerCase().replace(/[\s-]/g, ''));
                });
            }

            const membersPerPageSelect = document.getElementById('members-per-page-select');
            if (membersPerPageSelect) {
                Array.from(membersPerPageSelect.options).forEach(option => {
                    if (option.value === 'all') {
                        option.textContent = getTranslation('show') + ' ' + getTranslation('allStatuses');
                    } else {
                        option.textContent = getTranslation('show') + ' ' + option.value;
                    }
                });
            }

            const statueSelect = document.getElementById('member-statue');
            if (statueSelect) {
                Array.from(statueSelect.options).forEach(option => {
                    // Special handling for "Select Statue" option
                    if (option.value === '') {
                        option.textContent = getTranslation('selectStatue');
                    } else {
                        option.textContent = getTranslation(option.value.toLowerCase().replace(/[\s-]/g, '') || option.value); // Fallback to option.value
                    }
                });
            }
        }


        function updateHeader() {
            // Update theme button icon
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (themeToggleBtn) {
                themeToggleBtn.innerHTML = appState.theme === 'light' ?
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z" />
                    </svg>` :
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M3 12H2m8.003-9.997l-.707-.707M10.707 2.293l.707-.707m-4.003 10.997l-.707.707M3.293 13.293l-.707.707m18.414-1.414l-.707-.707M20.707 10.707l.707-.707m-4.003-10.997l.707-.707M13.293 3.293l.707-.707" />
                    </svg>`;
            }

            // Update settings button active state
            const settingsButton = document.getElementById('settings-button');
            if (settingsButton) {
                if (appState.activeSection === 'settings') {
                    settingsButton.classList.add('bg-indigo-600', 'text-white');
                } else {
                    settingsButton.classList.remove('bg-indigo-600', 'text-white');
                }
            }
        }

        function updateSidebar() {
            const navButtons = [
                document.getElementById('nav-dashboard'),
                document.getElementById('nav-members'),
                document.getElementById('nav-events'),
                document.getElementById('nav-reports')
            ];

            navButtons.forEach(button => {
                const sectionId = button.id.replace('nav-', '');
                if (sectionId === appState.activeSection) {
                    button.classList.add('bg-indigo-100', 'text-indigo-700', 'font-medium', 'dark:bg-indigo-700', 'dark:text-white');
                    button.classList.remove('text-gray-700', 'hover:bg-gray-50', 'dark:text-gray-300', 'dark:hover:bg-gray-700');
                } else {
                    button.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-medium', 'dark:bg-indigo-700', 'dark:text-white');
                    button.classList.add('text-gray-700', 'hover:bg-gray-50', 'dark:text-gray-300', 'dark:hover:bg-gray-700');
                }
            });
        }

        function showLoadingSpinner() {
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        }

        function hideLoadingSpinner() {
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }

        function renderActiveSection() {
            const sections = ['dashboard-section', 'members-section', 'events-section', 'reports-section', 'settings-section'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    if (sectionId === `${appState.activeSection}-section`) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                }
            });

            // Render content for the active section
            switch (appState.activeSection) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'members':
                    renderMembers();
                    break;
                case 'events':
                    renderEvents();
                    break;
                case 'reports':
                    renderReports();
                    break;
                case 'settings':
                    renderSettings();
                    break;
            }
        }

        function renderDashboard() {
            const totalMembers = appState.members.length;
            const activeMembersCount = appState.members.filter(member => member.status === 'Active').length;
            const newBelieverCount = appState.members.filter(member => member.status === 'New believer').length;
            const service1Count = appState.members.filter(member => member.service === 'Service 1').length;
            const service2Count = appState.members.filter(member => member.service === 'Service 2').length;
            const eventCount = appState.events.length;

            document.getElementById('total-members-count').textContent = totalMembers;
            document.getElementById('active-members-count').textContent = activeMembersCount;
            document.getElementById('new-believers-count').textContent = newBelieverCount;
            document.getElementById('service1-members-count').textContent = service1Count;
            document.getElementById('service2-members-count').textContent = service2Count;
            document.getElementById('upcoming-events-count').textContent = eventCount;
        }

        function renderMembers() {
            const membersTableBody = document.getElementById('members-table-body');
            membersTableBody.innerHTML = ''; // Clear existing rows

            const filteredAndSearchedMembers = appState.members.filter(member => {
                const matchesSearch = (member.name && member.name.toLowerCase().includes(appState.appliedSearchQuery.toLowerCase())) ||
                                      (member.gender && member.gender.toLowerCase().includes(appState.appliedSearchQuery.toLowerCase()));
                const matchesStatus = appState.statusFilter === 'All' || (member.status && member.status === appState.statusFilter);
                return matchesSearch && matchesStatus;
            });

            const totalPages = Math.ceil(filteredAndSearchedMembers.length / appState.membersPerPage);
            const indexOfLastMember = appState.currentPage * appState.membersPerPage;
            const indexOfFirstMember = indexOfLastMember - appState.membersPerPage;
            const currentMembers = filteredAndSearchedMembers.slice(indexOfFirstMember, indexOfLastMember);

            if (currentMembers.length === 0) {
                membersTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-3 whitespace-nowrap text-center text-sm text-gray-500 dark:text-gray-400">
                            ${getTranslation('noMembersFound')}
                        </td>
                    </tr>
                `;
            } else {
                currentMembers.forEach(member => {
                    const row = membersTableBody.insertRow();
                    row.className = "hover:bg-gray-50 dark:hover:bg-gray-600";

                    const photoCell = row.insertCell();
                    photoCell.className = "px-4 py-3 whitespace-nowrap";
                    photoCell.innerHTML = `
                        <button class="focus:outline-none view-photo-btn" data-photo-url="${member.photo || 'https://placehold.co/400x400/cccccc/ffffff?text=Image+Not+Available'}">
                            ${member.photo ?
                                `<img src="${member.photo}" alt="${member.name}" class="h-10 w-10 rounded-full object-cover max-w-full" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/ffffff?text=N/A';" />` :
                                `<div class="h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center text-gray-500 dark:text-gray-300 text-xs">No Photo</div>`
                            }
                        </button>
                    `;

                    const nameCell = row.insertCell();
                    nameCell.className = "px-4 py-3 whitespace-nowrap";
                    nameCell.innerHTML = `
                        <button class="text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:underline focus:outline-none view-member-details-btn" data-member-id="${member.id}">
                            ${member.name || ''}
                        </button>
                    `;

                    const genderCell = row.insertCell();
                    genderCell.className = "px-4 py-3 whitespace-nowrap";
                    genderCell.textContent = member.gender || '';

                    const phoneCell = row.insertCell();
                    phoneCell.className = "px-4 py-3 whitespace-nowrap";
                    phoneCell.textContent = member.phone || '';

                    const statusCell = row.insertCell();
                    statusCell.className = "px-4 py-3 whitespace-nowrap";
                    const statusClass = member.status === 'Active' ? 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100' : 'bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100';
                    statusCell.innerHTML = `
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${getTranslation(member.status?.toLowerCase().replace(/[\s-]/g, '') || '') || member.status || ''}
                        </span>
                    `;

                    const actionsCell = row.insertCell();
                    actionsCell.className = "px-4 py-3 whitespace-nowrap text-sm font-medium flex space-x-2";
                    actionsCell.innerHTML = `
                        <button class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 edit-member-btn transition duration-200 ease-in-out" title="${getTranslation('editMember')}" data-member-id="${member.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.828-2.828z" />
                            </svg>
                        </button>
                        <button class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 delete-member-btn transition duration-200 ease-in-out" title="${getTranslation('delete')}" data-member-id="${member.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                });
            }

            // Render pagination
            const paginationNav = document.getElementById('members-pagination');
            const paginationNumbersDiv = document.getElementById('pagination-numbers');
            if (totalPages > 1) {
                paginationNav.classList.remove('hidden');
                paginationNumbersDiv.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.className = `px-3 py-2 ml-0 leading-tight border border-gray-300 dark:border-gray-700 rounded-md mx-1
                                            ${appState.currentPage === i ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white'}
                                            focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out`;
                    pageButton.addEventListener('click', () => {
                        appState.currentPage = i;
                        renderMembers();
                    });
                    paginationNumbersDiv.appendChild(pageButton);
                }
                document.getElementById('prev-page-btn').disabled = appState.currentPage === 1;
                document.getElementById('prev-page-btn').classList.toggle('opacity-50', appState.currentPage === 1);
                document.getElementById('prev-page-btn').classList.toggle('cursor-not-allowed', appState.currentPage === 1);

                document.getElementById('next-page-btn').disabled = appState.currentPage === totalPages;
                document.getElementById('next-page-btn').classList.toggle('opacity-50', appState.currentPage === totalPages);
                document.getElementById('next-page-btn').classList.toggle('cursor-not-allowed', appState.currentPage === totalPages);

            } else {
                paginationNav.classList.add('hidden');
            }
        }

        function renderEvents() {
            const eventsTableBody = document.getElementById('events-table-body');
            eventsTableBody.innerHTML = ''; // Clear existing rows

            if (appState.events.length === 0) {
                eventsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-3 whitespace-nowrap text-center text-sm text-gray-500 dark:text-gray-400">
                            ${getTranslation('noEventsFound')}
                        </td>
                    </tr>
                `;
            } else {
                appState.events.forEach(event => {
                    const row = eventsTableBody.insertRow();
                    row.className = "hover:bg-gray-50 dark:hover:bg-gray-600";
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${event.name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.date}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.time}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.location}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.service}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.team}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300 max-w-xs truncate">${event.description}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 edit-event-btn transition duration-200 ease-in-out" title="${getTranslation('editEvent')}" data-event-id="${event.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.828-2.828z" />
                                </svg>
                            </button>
                        </td>
                    `;
                });
            }
        }

        function renderReports() {
            const reportSelect = document.getElementById('report-select');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const generatedReportArea = document.getElementById('generated-report-area');
            const generatedReportTitle = document.getElementById('generated-report-title');
            const generatedReportContent = document.getElementById('generated-report-content');

            // Enable/disable generate button based on selection
            generateReportBtn.disabled = !reportSelect.value;
            generateReportBtn.classList.toggle('opacity-50', !reportSelect.value);
            generateReportBtn.classList.toggle('cursor-not-allowed', !reportSelect.value);

            // Hide report area if no report is selected or generated
            if (!reportSelect.value || !appState.generatedReportData) {
                generatedReportArea.classList.add('hidden');
                return;
            }

            generatedReportArea.classList.remove('hidden');
            let selectedReportType = reportSelect.value;

            if (selectedReportType === 'Monthly Membership Comparison') {
                generatedReportTitle.textContent = getTranslation('reportTitleMonthlyComparison');
                let tableHtml = `
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${getTranslation('reportMonth')}</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${getTranslation('reportTotalMembers')}</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${getTranslation('reportNewMembers')}</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${getTranslation('reportActiveMembers')}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                `;
                appState.monthlyMembershipData.forEach(data => {
                    tableHtml += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${data.month}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${data.totalMembers}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${data.newMembers}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${data.activeMembers}</td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                generatedReportContent.innerHTML = tableHtml;
            } else {
                generatedReportTitle.textContent = selectedReportType;
                generatedReportContent.innerHTML = `<p class="text-gray-700 dark:text-gray-300">${appState.generatedReportData.message}</p>`;
            }
        }

        function renderSettings() {
            document.getElementById('language-select-setting').value = appState.language;
        }

        // --- Modal Functions ---
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function updateModals() {
            // This function ensures modals reflect the latest appState,
            // though their visibility is primarily controlled by showModal/hideModal.
            // It's mainly for re-populating forms if editingMember/editingEvent changes.
            if (document.getElementById('member-modal').classList.contains('hidden')) {
                // If modal is hidden, ensure editing state is cleared
                appState.editingMember = null;
            }
            if (document.getElementById('event-modal').classList.contains('hidden')) {
                appState.editingEvent = null;
            }
            // Re-translate modal titles/buttons if they are open
            translateElements();
        }

        function populateMemberForm(member) {
            // Get all form elements by their IDs directly
            const memberFirstNameInput = document.getElementById('member-firstName');
            const memberLastNameInput = document.getElementById('member-lastName');
            const memberGenderSelect = document.getElementById('member-gender');
            const memberDateOfBirthInput = document.getElementById('member-dateOfBirth');
            const memberMemberClassSelect = document.getElementById('member-memberClass');
            const memberStatueSelect = document.getElementById('member-statue');
            const memberFromInput = document.getElementById('member-from');
            const memberServiceSelect = document.getElementById('member-service');
            const memberPhoneNumberInput = document.getElementById('member-phoneNumber');
            const memberEmergencyNumberInput = document.getElementById('member-emergencyNumber');
            const memberFacebookInput = document.getElementById('member-facebook');
            const memberTelegramInput = document.getElementById('member-telegram');
            const memberTemperatureInput = document.getElementById('member-temperature'); // New temperature input

            const photoPreview = document.getElementById('photo-preview');
            const photoPlaceholder = document.getElementById('photo-placeholder');

            if (member) {
                document.getElementById('member-modal-title').textContent = getTranslation('editMember');
                document.getElementById('member-modal-save-btn').textContent = getTranslation('saveChanges');

                // Populate fields if elements exist
                if (memberFirstNameInput) memberFirstNameInput.value = member.firstName || '';
                if (memberLastNameInput) memberLastNameInput.value = member.lastName || '';
                if (memberGenderSelect) memberGenderSelect.value = member.gender || '';
                if (memberDateOfBirthInput) memberDateOfBirthInput.value = member.dateOfBirth || '';
                if (memberMemberClassSelect) memberMemberClassSelect.value = member.memberClass || '';
                if (memberStatueSelect) memberStatueSelect.value = member.statue || '';
                if (memberFromInput) memberFromInput.value = member.from || '';
                if (memberServiceSelect) memberServiceSelect.value = member.service || '';
                if (memberPhoneNumberInput) memberPhoneNumberInput.value = member.phone || '';
                if (memberEmergencyNumberInput) memberEmergencyNumberInput.value = member.emergencyNumber || '';
                if (memberFacebookInput) memberFacebookInput.value = member.facebook || '';
                if (memberTelegramInput) memberTelegramInput.value = member.telegram || '';
                if (memberTemperatureInput) memberTemperatureInput.value = member.temperature || ''; // Populate temperature
            } else {
                document.getElementById('member-modal-title').textContent = getTranslation('addMember');
                document.getElementById('member-modal-save-btn').textContent = getTranslation('addMember');
                // Clear all form fields
                if (memberFirstNameInput) memberFirstNameInput.value = '';
                if (memberLastNameInput) memberLastNameInput.value = '';
                if (memberGenderSelect) memberGenderSelect.value = '';
                if (memberDateOfBirthInput) memberDateOfBirthInput.value = '';
                if (memberMemberClassSelect) memberMemberClassSelect.value = '';
                if (memberStatueSelect) memberStatueSelect.value = '';
                if (memberFromInput) memberFromInput.value = '';
                if (memberServiceSelect) memberServiceSelect.value = '';
                if (memberPhoneNumberInput) memberPhoneNumberInput.value = '';
                if (memberEmergencyNumberInput) memberEmergencyNumberInput.value = '';
                if (memberFacebookInput) memberFacebookInput.value = '';
                if (memberTelegramInput) memberTelegramInput.value = '';
                if (memberTemperatureInput) memberTemperatureInput.value = ''; // Clear temperature

                photoPreview.src = '';
                photoPreview.classList.add('hidden');
                photoPlaceholder.classList.remove('hidden');
            }
        }

        function populateMemberDetails(member) {
            const detailsContent = document.getElementById('member-details-content');
            if (!member) {
                detailsContent.innerHTML = '';
                return;
            }

            let html = '';
            if (member.photo) {
                html += `<div class="md:col-span-2 flex justify-center mb-4">
                            <img src="${member.photo}" alt="Profile" class="h-32 w-32 rounded-full object-cover max-w-full" />
                        </div>`;
            }
            html += `
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('firstName')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.firstName || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('lastName')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.lastName || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('gender')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.gender || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('dateOfBirth')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.dateOfBirth || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('memberClass')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.memberClass || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('status')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${getTranslation(member.status?.toLowerCase().replace(/[\s-]/g, '') || '') || member.status || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('fromAddressOrigin')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.from || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('serviceEg').split(' ')[0]}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.service || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('phoneNumber')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.phone || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('emergencyNumber')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.emergencyNumber || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('facebookProfile')}:</p>
                    <p class="mt-1 text-blue-600 dark:text-blue-400 break-words">${member.facebook || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('telegramID')}:</p>
                    <p class="mt-1 text-blue-600 dark:text-blue-400 break-words">${member.telegram || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('statue')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${getTranslation(member.statue?.toLowerCase().replace(/[\s-]/g, '') || '') || member.statue || ''}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${getTranslation('temperature')}:</p>
                    <p class="mt-1 text-gray-900 dark:text-gray-100">${member.temperature ? `${member.temperature}Â°C` : ''}</p>
                </div>
            `;
            detailsContent.innerHTML = html;
        }

        function populateEventForm(event) {
            const form = document.getElementById('event-form');
            if (event) {
                document.getElementById('event-modal-title').textContent = getTranslation('editEvent');
                document.getElementById('event-modal-save-btn').textContent = getTranslation('saveChanges');
                form.elements['name'].value = event.name || '';
                form.elements['date'].value = event.date || '';
                form.elements['time'].value = event.time || '';
                form.elements['location'].value = event.location || '';
                form.elements['description'].value = event.description || '';
                form.elements['service'].value = event.service || '';
                form.elements['team'].value = event.team || '';
            } else {
                document.getElementById('event-modal-title').textContent = getTranslation('addEvent');
                document.getElementById('event-modal-save-btn').textContent = getTranslation('addEvent');
                form.reset(); // Clear all form fields
            }
        }

        // --- Data Operations (Firestore) ---
        async function addMember(newMemberData) {
            showLoadingSpinner();
            try {
                if (!db || !appState.userId) throw new Error("Firestore not initialized or user not authenticated.");
                await addDoc(membersCollectionRef, newMemberData);
            } catch (error) {
                console.error("Error adding member:", error);
                alert("Failed to add member. Please try again.");
            } finally {
                hideLoadingSpinner();
            }
        }

        async function editMember(memberId, updatedMemberData) {
            showLoadingSpinner();
            try {
                if (!db || !appState.userId) throw new Error("Firestore not initialized or user not authenticated.");
                const memberDocRef = doc(db, `${appState.privateCollectionPath}/members`, memberId);
                await setDoc(memberDocRef, updatedMemberData, { merge: true });
            } catch (error) {
                console.error("Error updating member:", error);
                alert("Failed to update member. Please try again.");
            } finally {
                hideLoadingSpinner();
            }
        }

        async function deleteMember(memberId) {
            showLoadingSpinner();
            try {
                if (!db || !appState.userId) throw new Error("Firestore not initialized or user not authenticated.");
                const memberDocRef = doc(db, `${appState.privateCollectionPath}/members`, memberId);
                await deleteDoc(memberDocRef);
            } catch (error) {
                console.error("Error deleting member:", error);
                alert("Failed to delete member. Please try again.");
            } finally {
                hideLoadingSpinner();
            }
        }

        async function addEvent(newEventData) {
            showLoadingSpinner();
            try {
                if (!db || !appState.userId) throw new Error("Firestore not initialized or user not authenticated.");
                await addDoc(eventsCollectionRef, newEventData);
            } catch (error) {
                console.error("Error adding event:", error);
                alert("Failed to add event. Please try again.");
            } finally {
                hideLoadingSpinner();
            }
        }

        async function editEvent(eventId, updatedEventData) {
            showLoadingSpinner();
            try {
                if (!db || !appState.userId) throw new Error("Firestore not initialized or user not authenticated.");
                const eventDocRef = doc(db, `${appState.privateCollectionPath}/events`, eventId);
                await setDoc(eventDocRef, updatedEventData, { merge: true });
            } catch (error) {
                console.error("Error updating event:", error);
                alert("Failed to update event. Please try again.");
            } finally {
                hideLoadingSpinner();
            }
        }

        // --- Firebase Initialization and Auth ---
        // Explicitly initialize variables to null or appropriate defaults
        let db = null;
        let auth = null;
        let membersCollectionRef = null;
        let eventsCollectionRef = null;

        console.log("Script started: Church Management System"); // Added for debugging

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Firebase config is passed as a global variable by the Canvas environment
                let rawFirebaseConfig = '{}';
                if (typeof __firebase_config !== 'undefined') {
                    rawFirebaseConfig = __firebase_config;
                }
                const firebaseConfig = JSON.parse(rawFirebaseConfig);

                let rawAppId = 'default-app-id';
                if (typeof __app_id !== 'undefined') {
                    rawAppId = __app_id;
                }
                const appId = rawAppId;

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        appState.userId = user.uid;
                    } else {
                        let initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                appState.userId = auth.currentUser.uid;
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                await signInAnonymously(auth);
                                appState.userId = auth.currentUser.uid;
                            }
                        } else {
                            await signInAnonymously(auth);
                            appState.userId = auth.currentUser.uid;
                        }
                    }
                    appState.privateCollectionPath = `artifacts/${appId}/users/${appState.userId}`;
                    membersCollectionRef = collection(db, `${appState.privateCollectionPath}/members`);
                    eventsCollectionRef = collection(db, `${appState.privateCollectionPath}/events`);
                    appState.isAuthReady = true;

                    // --- NEW LOGIC FOR DUMMY DATA POPULATION ---
                    if (!appState.hasCheckedForInitialMembers && appState.userId) {
                        const membersSnapshot = await getDocs(membersCollectionRef);
                        if (membersSnapshot.empty) {
                            console.log("Firestore members collection is empty. Populating with dummy data.");
                            const dummyMembers = [
                                {
                                    firstName: 'John', lastName: 'Doe', name: 'John Doe', gender: 'Male', dateOfBirth: '1990-01-15',
                                    memberClass: 'Discipleship', status: 'Active', from: 'Phnom Penh', service: 'Choir',
                                    phone: '012345678', emergencyNumber: '098765432', facebook: 'facebook.com/johndoe',
                                    telegram: '@johndoe', statue: 'Done', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=JD', temperature: 36.5
                                },
                                {
                                    firstName: 'Maly', lastName: 'Chan', name: 'Maly Chan', gender: 'Female', dateOfBirth: '1992-05-20',
                                    memberClass: 'Changing Life', status: 'New believer', from: 'Siem Reap', service: 'Usher',
                                    phone: '010987654', emergencyNumber: '011234567', facebook: 'facebook.com/malychan',
                                    telegram: '@malychan', statue: 'Not yet', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=MC', temperature: 37.0
                                },
                                {
                                    firstName: 'Sok', lastName: 'Ly', name: 'Sok Ly', gender: 'Male', dateOfBirth: '1985-11-01',
                                    memberClass: 'Life Guidance Class', status: 'Active', from: 'Battambang', service: 'Service 1',
                                    phone: '015123456', emergencyNumber: '016789012', facebook: 'facebook.com/sokly',
                                    telegram: '@sokly', statue: 'Done', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=SL', temperature: 36.8
                                },
                                {
                                    firstName: 'Dara', lastName: 'Kim', name: 'Dara Kim', gender: 'Female', dateOfBirth: '1998-03-25',
                                    memberClass: 'SOM', status: 'Cell group', from: 'Kandal', service: 'Service 2',
                                    phone: '077888999', emergencyNumber: '088777666', facebook: 'facebook.com/darakim',
                                    telegram: '@darakim', statue: 'Done', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=DK', temperature: 36.2
                                },
                                {
                                    firstName: 'Vannak', lastName: 'Chea', name: 'Vannak Chea', gender: 'Male', dateOfBirth: '2000-07-07',
                                    memberClass: 'Leadership', status: 'Visitor', from: 'Kampong Cham', service: 'Other',
                                    phone: '069111222', emergencyNumber: '096333444', facebook: 'facebook.com/vannakc',
                                    telegram: '@vannakc', statue: 'Not yet', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=VC', temperature: 37.1
                                },
                                {
                                    firstName: 'Srey', lastName: 'Mom', name: 'Srey Mom', gender: 'Female', dateOfBirth: '1995-02-10',
                                    memberClass: 'Discipleship', status: 'Active', from: 'Pursat', service: 'Choir',
                                    phone: '012111222', emergencyNumber: '098111222', facebook: 'facebook.com/sreymom',
                                    telegram: '@sreymom', statue: 'Done', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=SM', temperature: 36.7
                                },
                                {
                                    firstName: 'Chann', lastName: 'Phal', name: 'Chann Phal', gender: 'Male', dateOfBirth: '1988-09-05',
                                    memberClass: 'Life Guidance Class', status: 'Active', from: 'Takeo', service: 'Usher',
                                    phone: '010222333', emergencyNumber: '011333444', facebook: 'facebook.com/channphal',
                                    telegram: '@channphal', statue: 'Done', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=CP', temperature: 36.9
                                },
                                {
                                    firstName: 'Leakhena', lastName: 'Pov', name: 'Leakhena Pov', gender: 'Female', dateOfBirth: '1991-04-22',
                                    memberClass: 'Changing Life', status: 'New believer', from: 'Kampong Speu', service: 'Service 1',
                                    phone: '015444555', emergencyNumber: '016555666', facebook: 'facebook.com/leakhenapov',
                                    telegram: '@leakhenapov', statue: 'Not yet', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=LP', temperature: 37.2
                                },
                                {
                                    firstName: 'Rithy', lastName: 'Sok', name: 'Rithy Sok', gender: 'Male', dateOfBirth: '1979-11-30',
                                    memberClass: 'Leadership', status: 'Cell group', from: 'Prey Veng', service: 'Service 2',
                                    phone: '077999888', emergencyNumber: '088666555', facebook: 'facebook.com/rithysok',
                                    telegram: '@rithysok', statue: 'Done', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=RS', temperature: 36.4
                                },
                                {
                                    firstName: 'Sovann', lastName: 'Roth', name: 'Sovann Roth', gender: 'Female', dateOfBirth: '2001-08-18',
                                    memberClass: 'SOM', status: 'Visitor', from: 'Svay Rieng', service: 'Other',
                                    phone: '069777888', emergencyNumber: '096999000', facebook: 'facebook.com/sovannroth',
                                    telegram: '@sovannroth', statue: 'Not yet', photo: 'https://placehold.co/50x50/cccccc/ffffff?text=SR', temperature: 37.0
                                }
                            ];
                            for (const member of dummyMembers) {
                                await addDoc(membersCollectionRef, member);
                            }
                        }
                        appState.hasCheckedForInitialMembers = true; // Mark as checked
                    }
                    // --- END NEW LOGIC ---

                    hideLoadingSpinner();
                    setupFirestoreListeners(); // Now set up the real-time listener
                    updateUI(); // Initial UI render after auth and potential dummy data population
                });
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                appState.isAuthReady = true; // Mark as ready even on error to avoid infinite loading
                hideLoadingSpinner();
                updateUI();
            }

            // Dynamically load XLSX library
            const loadScript = (src, id, onloadCallback) => {
                if (!document.getElementById(id)) {
                    const script = document.createElement('script');
                    script.src = src;
                    script.id = id;
                    script.onload = onloadCallback;
                    script.onerror = () => console.error(`Failed to load script: ${src}`);
                    document.head.appendChild(script);
                } else if (onloadCallback) {
                    onloadCallback();
                }
            };
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js', 'xlsx-script', () => {
                console.log('XLSX loaded');
            });
        });

        function setupFirestoreListeners() {
            if (appState.db && appState.userId) {
                // Members listener
                onSnapshot(membersCollectionRef, (snapshot) => {
                    appState.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.isLoading = false;
                    updateUI();
                }, (error) => {
                    console.error("Error fetching members:", error);
                    appState.isLoading = false;
                    updateUI();
                });

                // Events listener
                onSnapshot(eventsCollectionRef, (snapshot) => {
                    appState.events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateUI();
                }, (error) => {
                    console.error("Error fetching events:", error);
                });
            }
        }

        // --- Event Listeners ---
        document.getElementById('theme-toggle').addEventListener('click', () => {
            appState.theme = appState.theme === 'light' ? 'dark' : 'light';
            document.documentElement.classList.toggle('dark', appState.theme === 'dark');
            document.body.classList.toggle('bg-gray-900', appState.theme === 'dark');
            document.body.classList.toggle('text-gray-100', appState.theme === 'dark');
            document.body.classList.toggle('bg-gray-100', appState.theme === 'light');
            document.body.classList.toggle('text-gray-900', appState.theme === 'light');
            updateHeader(); // Update icon
        });

        // Sidebar navigation
        document.getElementById('nav-dashboard').addEventListener('click', () => { appState.activeSection = 'dashboard'; updateUI(); });
        document.getElementById('nav-members').addEventListener('click', () => { appState.activeSection = 'members'; updateUI(); });
        document.getElementById('nav-events').addEventListener('click', () => { appState.activeSection = 'events'; updateUI(); });
        document.getElementById('nav-reports').addEventListener('click', () => { appState.activeSection = 'reports'; updateUI(); });
        document.getElementById('settings-button').addEventListener('click', () => { appState.activeSection = 'settings'; updateUI(); });

        // Dashboard quick actions
        document.getElementById('add-new-member-dashboard-btn').addEventListener('click', () => {
            appState.activeSection = 'members';
            appState.editingMember = null;
            updateUI();
            populateMemberForm(null);
            showModal('member-modal');
        });
        document.getElementById('create-new-event-dashboard-btn').addEventListener('click', () => {
            appState.activeSection = 'events';
            appState.editingEvent = null;
            updateUI();
            populateEventForm(null);
            showModal('event-modal');
        });

        // Members section actions
        document.getElementById('execute-search-button').addEventListener('click', () => {
            appState.appliedSearchQuery = document.getElementById('member-search-input').value;
            appState.currentPage = 1; // Reset to first page on new search
            renderMembers();
        });
        document.getElementById('status-filter-select').addEventListener('change', (e) => {
            appState.statusFilter = e.target.value;
            appState.currentPage = 1; // Reset to first page on new filter
            renderMembers();
        });
        document.getElementById('members-per-page-select').addEventListener('change', (e) => {
            appState.membersPerPage = e.target.value === 'all' ? appState.members.length : Number(e.target.value);
            appState.currentPage = 1; // Reset to first page on new page size
            renderMembers();
        });
        document.getElementById('add-new-member-btn').addEventListener('click', () => {
            appState.editingMember = null;
            populateMemberForm(null);
            showModal('member-modal');
        });

        document.getElementById('importExcel').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    if (typeof window.XLSX === 'undefined') {
                        console.error("XLSX library not loaded.");
                        alert("Excel import is not ready. Please try again or refresh the page.");
                        return;
                    }

                    const data = new Uint8Array(e.target.result);
                    const workbook = window.XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = window.XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                    if (!db || !appState.userId) {
                        console.error("Firestore not initialized or user not authenticated.");
                        alert("Firestore not ready. Please try again.");
                        return;
                    }

                    for (let row of worksheet) {
                        const newMemberData = {
                            name: row['Name'] || `${row['First Name'] || ''} ${row['Last Name'] || ''}`.trim(),
                            status: row['Status'] || 'Active',
                            gender: row['Gender'] || 'Unknown',
                            phone: row['Phone Number'] || '',
                            service: row['Service'] || 'Other',
                            photo: row['Photo'] || '',
                            facebook: row['Facebook'] || '',
                            telegram: row['Telegram'] || '',
                            lastName: row['Last Name'] || '',
                            firstName: row['First Name'] || '',
                            dateOfBirth: row['Date of Birth'] || '',
                            memberClass: row['Class'] || '',
                            from: row['From'] || '',
                            emergencyNumber: row['Emergency Number'] || '',
                            statue: row['Statue'] || '',
                            temperature: row['Temperature'] || '', // Include temperature from Excel
                        };
                        await addDoc(membersCollectionRef, newMemberData);
                    }
                    alert('Members imported successfully!');
                } catch (error) {
                    console.error('Error importing Excel file:', error);
                    alert('Failed to import Excel file. Please ensure it is a valid Excel format and columns match expected headers.');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('export-excel-btn').addEventListener('click', () => {
            if (typeof window.XLSX === 'undefined') {
                console.error("XLSX library not loaded.");
                alert("Excel export is not ready. Please try again or refresh the page.");
                return;
            }

            const headers = ["ID", "Name", "Status", "Gender", "Phone", "Service", "Facebook", "Telegram", "Last Name", "First Name", "Date of Birth", "Class", "From", "Emergency Number", "Statue", "Temperature"]; // Added Temperature
            const rows = appState.members.map(member => [
                member.id,
                member.name,
                member.status,
                member.gender,
                member.phone,
                member.service,
                member.facebook,
                member.telegram,
                member.lastName,
                member.firstName,
                member.dateOfBirth,
                member.memberClass,
                member.from,
                member.emergencyNumber,
                member.statue,
                member.temperature, // Added temperature to export
            ]);

            const worksheet = window.XLSX.utils.aoa_to_sheet([headers, ...rows]);
            const workbook = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(workbook, worksheet, "Members");
            window.XLSX.writeFile(workbook, "church_members.xlsx");
        });


        // Pagination buttons
        document.getElementById('prev-page-btn').addEventListener('click', () => {
            appState.currentPage = Math.max(1, appState.currentPage - 1);
            renderMembers();
        });
        document.getElementById('next-page-btn').addEventListener('click', () => {
            const filteredAndSearchedMembers = appState.members.filter(member => {
                const matchesSearch = (member.name && member.name.toLowerCase().includes(appState.appliedSearchQuery.toLowerCase())) ||
                                      (member.gender && member.gender.toLowerCase().includes(appState.appliedSearchQuery.toLowerCase()));
                const matchesStatus = appState.statusFilter === 'All' || (member.status && member.status === appState.statusFilter);
                return matchesSearch && matchesStatus;
            });
            const totalPages = Math.ceil(filteredAndSearchedMembers.length / appState.membersPerPage);
            appState.currentPage = Math.min(totalPages, appState.currentPage + 1);
            renderMembers();
        });

        // Event delegation for dynamically added member table buttons
        document.getElementById('members-table-body').addEventListener('click', (e) => {
            if (e.target.closest('.edit-member-btn')) {
                const memberId = e.target.closest('.edit-member-btn').dataset.memberId;
                appState.editingMember = appState.members.find(m => m.id === memberId);
                populateMemberForm(appState.editingMember);
                showModal('member-modal');
            } else if (e.target.closest('.delete-member-btn')) {
                const memberId = e.target.closest('.delete-member-btn').dataset.memberId;
                appState.memberToDelete = appState.members.find(m => m.id === memberId);
                document.getElementById('delete-confirmation-text').textContent = getTranslation('deleteConfirmation').replace('{memberName}', appState.memberToDelete.name);
                showModal('delete-confirm-modal');
            } else if (e.target.closest('.view-member-details-btn')) {
                const memberId = e.target.closest('.view-member-details-btn').dataset.memberId;
                appState.selectedMember = appState.members.find(m => m.id === memberId);
                populateMemberDetails(appState.selectedMember);
                showModal('member-details-modal');
            } else if (e.target.closest('.view-photo-btn')) {
                const photoUrl = e.target.closest('.view-photo-btn').dataset.photoUrl;
                document.getElementById('photo-modal-image').src = photoUrl;
                showModal('photo-modal');
            }
        });

        // Member Modal form submission
        document.getElementById('member-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = {
                firstName: document.getElementById('member-firstName').value,
                lastName: document.getElementById('member-lastName').value,
                gender: document.getElementById('member-gender').value,
                dateOfBirth: document.getElementById('member-dateOfBirth').value,
                memberClass: document.getElementById('member-memberClass').value,
                statue: document.getElementById('member-statue').value,
                from: document.getElementById('member-from').value,
                service: document.getElementById('member-service').value,
                phone: document.getElementById('member-phoneNumber').value,
                emergencyNumber: document.getElementById('member-emergencyNumber').value,
                facebook: document.getElementById('member-facebook').value,
                telegram: document.getElementById('member-telegram').value,
                temperature: document.getElementById('member-temperature').value, // Get temperature value
                status: appState.editingMember ? appState.editingMember.status : 'Active',
            };
            formData.name = `${formData.firstName} ${formData.lastName}`.trim();

            const photoFile = document.getElementById('member-photo-upload').files[0];
            if (photoFile) {
                const reader = new FileReader();
                reader.onloadend = async () => {
                    formData.photo = reader.result;
                    if (appState.editingMember) {
                        await editMember(appState.editingMember.id, formData);
                    } else {
                        await addMember(formData);
                    }
                    hideModal('member-modal');
                };
                reader.readAsDataURL(photoFile);
            } else {
                formData.photo = appState.editingMember ? appState.editingMember.photo : '';
                if (appState.editingMember) {
                    await editMember(appState.editingMember.id, formData);
                } else {
                    await addMember(formData);
                }
                hideModal('member-modal');
            }
        });

        // Member Modal cancel button
        document.getElementById('member-modal-cancel-btn').addEventListener('click', () => {
            hideModal('member-modal');
        });

        // Member Details Modal close button
        document.getElementById('member-details-close-btn').addEventListener('click', () => {
            hideModal('member-details-modal');
            appState.selectedMember = null;
        });

        // Photo Modal close button
        document.getElementById('photo-modal-close-btn').addEventListener('click', () => {
            hideModal('photo-modal');
            document.getElementById('photo-modal-image').src = ''; // Clear image
        });

        // Delete Confirm Modal buttons
        document.getElementById('delete-cancel-btn').addEventListener('click', () => {
            hideModal('delete-confirm-modal');
            appState.memberToDelete = null;
        });
        document.getElementById('delete-confirm-btn').addEventListener('click', async () => {
            if (appState.memberToDelete) {
                await deleteMember(appState.memberToDelete.id);
                hideModal('delete-confirm-modal');
                appState.memberToDelete = null;
            }
        });

        // Events section actions
        document.getElementById('create-new-event-btn').addEventListener('click', () => {
            appState.editingEvent = null;
            populateEventForm(null);
            showModal('event-modal');
        });

        // Event delegation for dynamically added event table buttons
        document.getElementById('events-table-body').addEventListener('click', (e) => {
            if (e.target.closest('.edit-event-btn')) {
                const eventId = e.target.closest('.edit-event-btn').dataset.eventId;
                appState.editingEvent = appState.events.find(ev => ev.id === eventId);
                populateEventForm(appState.editingEvent);
                showModal('event-modal');
            }
        });

        // Event Modal form submission
        document.getElementById('event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = {
                name: form.elements['name'].value,
                date: form.elements['date'].value,
                time: form.elements['time'].value,
                location: form.elements['location'].value,
                description: form.elements['description'].value,
                service: form.elements['service'].value,
                team: form.elements['team'].value,
            };

            if (appState.editingEvent) {
                await editEvent(appState.editingEvent.id, formData);
            } else {
                await addEvent(formData);
            }
            hideModal('event-modal');
        });

        // Event Modal cancel button
        document.getElementById('event-modal-cancel-btn').addEventListener('click', () => {
            hideModal('event-modal');
        });

        // Reports section actions
        document.getElementById('report-select').addEventListener('change', (e) => {
            appState.selectedReportType = e.target.value;
            appState.generatedReportData = null; // Clear previous report data
            renderReports(); // Re-render to update button state
        });
        document.getElementById('generate-report-btn').addEventListener('click', () => {
            let selectedReportType = document.getElementById('report-select').value;
            if (selectedReportType === 'Monthly Membership Comparison') {
                appState.generatedReportData = appState.monthlyMembershipData;
            } else {
                appState.generatedReportData = { message: `Generating ${selectedReportType} Report... (Not implemented yet)` };
            }
            renderReports();
        });

        // Settings section actions
        document.getElementById('language-select-setting').addEventListener('change', (e) => {
            appState.language = e.target.value;
            updateUI(); // Re-render entire UI for new language
        });
    </script>
</body>
</html>
