<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Management System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter for a clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS (xlsx) for Excel import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF and jspdf-autotable for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for modals */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark .modal-content::-webkit-scrollbar-track {
            background: #4a5568;
        }
        .dark .modal-content::-webkit-scrollbar-thumb {
            background: #a0aec0;
        }
        .dark .modal-content::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-900 font-sans">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold rounded-md px-2 py-1" id="system-name"></h1>
            <nav>
                <ul class="flex space-x-4 items-center">
                    <li>
                        <!-- Removed transition duration-300 -->
                        <a href="#" class="hover:text-indigo-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span id="profile-link-text"></span>
                        </a>
                    </li>
                    <li>
                        <!-- Removed transition duration-300 -->
                        <button id="theme-toggle" class="px-2 py-1 rounded-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                            <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z" />
                            </svg>
                            <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M3 12H2m8.003-9.997l-.707-.707M10.707 2.293l.707-.707m-4.003 10.997l-.707.707M3.293 13.293l-.707.707m18.414-1.414l-.707-.707M20.707 10.707l.707-.707m-4.003-10.997l.707-.707M13.293 3.293l.707-.707" />
                            </svg>
                        </button>
                    </li>
                    <li>
                        <!-- Removed transition duration-300 -->
                        <button id="settings-button" class="hover:text-indigo-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span id="settings-link-text"></span>
                        </button>
                    </li>
                    <li>
                        <!-- Removed transition duration-300 -->
                        <a href="#" class="hover:text-indigo-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            <span id="logout-link-text"></span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="container mx-auto flex flex-col lg:flex-row mt-8 p-4 lg:p-0">
        <!-- Sidebar Navigation -->
        <aside class="w-full lg:w-1/4 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 lg:mr-8 mb-8 lg:mb-0">
            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Navigation</h3>
            <nav>
                <ul>
                    <li class="mb-3">
                        <!-- Removed transition duration-300 -->
                        <button id="dashboard-nav-button" class="w-full text-left px-4 py-2 rounded-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7-7-7m7 7v10a1 1 0 01-1 1h-3" />
                            </svg>
                            <span id="dashboard-nav-text"></span>
                        </button>
                    </li>
                    <li class="mb-3">
                        <!-- Removed transition duration-300 -->
                        <button id="members-nav-button" class="w-full text-left px-4 py-2 rounded-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h2a2 2 0 002-2V7a2 2 0 00-2-2h-2v12m-2 2h-2a2 2 0 01-2-2V7a2 2 0 012-2h2m-6 0H4a2 2 0 00-2 2v10a2 2 0 002 2h2" />
                            </svg>
                            <span id="members-nav-text"></span>
                        </button>
                    </li>
                    <li class="mb-3">
                        <!-- Removed transition duration-300 -->
                        <button id="events-nav-button" class="w-full text-left px-4 py-2 rounded-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span id="events-nav-text"></span>
                        </button>
                    </li>
                    <li class="mb-3">
                        <!-- Removed transition duration-300 -->
                        <button id="reports-nav-button" class="w-full text-left px-4 py-2 rounded-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-5m3 5v-8m3 5v-2M9 21h6a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span id="reports-nav-text"></span>
                        </button>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content Display -->
        <main id="main-content" class="w-full lg:w-3/4">
            <div id="loading-indicator" class="flex justify-center items-center h-64 hidden">
                <!-- Removed animate-spin class here -->
                <div class="rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 dark:border-indigo-300"></div>
                <p id="loading-text" class="ml-4 text-lg text-gray-700 dark:text-gray-300"></p>
            </div>
            <div id="content-area" class="p-6 bg-white dark:bg-gray-700 rounded-lg shadow-md text-gray-900 dark:text-gray-100">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Add/Edit Member Modal -->
    <div id="add-edit-member-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-75">
        <!-- Removed transform transition-all scale-100 opacity-100 duration-300 ease-out from here -->
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <h3 id="member-modal-title" class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-6 border-b pb-3 border-gray-200 dark:border-gray-600"></h3>
            <form id="member-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Photo Upload -->
                <div class="md:col-span-2 flex flex-col items-center mb-4">
                    <label for="member-photo-upload" id="profile-photo-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"></label>
                    <div class="relative w-24 h-24 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                        <img id="member-photo-preview" src="" alt="Profile" class="w-full h-full object-cover hidden" />
                        <svg id="member-photo-placeholder" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <input
                        type="file"
                        id="member-photo-upload"
                        name="photo"
                        accept="image/*"
                        class="mt-3 text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                    />
                </div>

                <div>
                    <label for="member-firstName" id="first-name-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="text" id="member-firstName" name="firstName" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="member-lastName" id="last-name-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="text" id="member-lastName" name="lastName" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="member-gender" id="gender-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <select id="member-gender" name="gender" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="" id="select-gender-option"></option>
                        <option value="Male" id="gender-male-option"></option>
                        <option value="Female" id="gender-female-option"></option>
                        <option value="Other" id="gender-other-option"></option>
                    </select>
                </div>
                <div>
                    <label for="member-dateOfBirth" id="date-of-birth-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="date" id="member-dateOfBirth" name="dateOfBirth" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="member-memberClass" id="member-class-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="text" id="member-memberClass" name="memberClass" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="member-status" id="status-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <select id="member-status" name="status" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="" id="all-statuses-option"></option>
                        <option value="Active" id="status-active-option"></option>
                        <option value="Inactive" id="status-inactive-option"></option>
                        <option value="Pending" id="status-pending-option"></option>
                        <option value="Cell group" id="status-cell-group-option"></option>
                        <option value="Parth-Way" id="status-parth-way-option"></option>
                        <option value="New believer" id="status-new-believer-option"></option>
                        <option value="Visitor" id="status-visitor-option"></option>
                    </select>
                </div>
                <div>
                    <label for="member-from" id="from-address-origin-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="text" id="member-from" name="from" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="member-service" id="service-eg-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <select id="member-service" name="service" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" id="select-service-option"></option>
                        <option value="Service 1">Service 1</option>
                        <option value="Service 2">Service 2</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="member-phoneNumber" id="phone-number-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="tel" id="member-phoneNumber" name="phoneNumber" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="member-emergencyNumber" id="emergency-number-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="tel" id="member-emergencyNumber" name="emergencyNumber" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="member-facebook" id="facebook-profile-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="text" id="member-facebook" name="facebook" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., facebook.com/yourprofile" />
                </div>
                <div>
                    <label for="member-telegram" id="telegram-id-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="text" id="member-telegram" name="telegram" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., @yourtelegramid" />
                </div>
                <div class="col-span-1 md:col-span-2 flex justify-end space-x-3 mt-4">
                    <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                    <button type="button" id="member-modal-cancel-button" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"></button>
                    <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                    <button type="submit" id="member-modal-submit-button" class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Member Details Modal -->
    <div id="member-details-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-75">
        <!-- Removed transform transition-all scale-100 opacity-100 duration-300 ease-out from here -->
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <h3 id="member-details-title" class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-6 border-b pb-3 border-gray-200 dark:border-gray-600"></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="member-details-photo-container" class="md:col-span-2 flex justify-center mb-4 hidden">
                    <img id="member-details-photo" src="" alt="Profile" class="h-32 w-32 rounded-full object-cover border-2 border-indigo-500" />
                </div>
                <div>
                    <p id="details-first-name-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-first-name" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div>
                    <p id="details-last-name-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-last-name" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div>
                    <p id="details-gender-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-gender" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div>
                    <p id="details-date-of-birth-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-date-of-birth" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div>
                    <p id="details-member-class-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-member-class" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div>
                    <p id="details-status-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-status" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div>
                    <p id="details-from-address-origin-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-from-address-origin" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div>
                    <p id="details-service-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-service" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div>
                    <p id="details-phone-number-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-phone-number" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div>
                    <p id="details-emergency-number-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-emergency-number" class="mt-1 text-gray-900 dark:text-gray-100"></p>
                </div>
                <div id="details-facebook-container" class="hidden">
                    <p id="details-facebook-profile-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-facebook" class="mt-1 text-blue-600 dark:text-blue-400 break-words"></p>
                </div>
                <div id="details-telegram-container" class="hidden">
                    <p id="details-telegram-id-label" class="text-sm font-medium text-gray-700 dark:text-gray-300"></p>
                    <p id="details-telegram" class="mt-1 text-blue-600 dark:text-blue-400 break-words"></p>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                <button id="member-details-close-button" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"></button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Event Modal -->
    <div id="add-edit-event-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-75">
        <!-- Removed transform transition-all scale-100 opacity-100 duration-300 ease-out from here -->
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <h3 id="event-modal-title" class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-6 border-b pb-3 border-gray-200 dark:border-gray-600"></h3>
            <form id="event-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="event-name" id="event-name-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="text" id="event-name" name="name" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="event-date" id="event-date-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="date" id="event-date" name="date" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="event-time" id="event-time-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <input type="time" id="event-time" name="time" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div>
                    <label for="event-location" id="event-location-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <select id="event-location" name="location" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="">Select Location</option>
                        <option value="Tual Sangkae">Tual Sangkae</option>
                        <option value="Stueng Meanchey">Stueng Meanchey</option>
                        <option value="Main Hall">Main Hall</option>
                        <option value="Youth Room">Youth Room</option>
                        <option value="City Park">City Park</option>
                        <option value="Sanctuary">Sanctuary</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="event-service" id="event-service-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <select id="event-service" name="service" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Service</option>
                        <option value="Service 1">Service 1</option>
                        <option value="Service 2">Service 2</option>
                        <option value="Worship">Worship</option>
                        <option value="Youth Ministry">Youth Ministry</option>
                        <option value="Community Service">Community Service</option>
                        <option value="Prayer Ministry">Prayer Ministry</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="event-team" id="event-team-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <select id="event-team" name="team" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Team</option>
                        <option value="Dynamic">Dynamic</option>
                        <option value="Static">Static</option>
                        <option value="Pastoral Team">Pastoral Team</option>
                        <option value="Youth Leaders">Youth Leaders</option>
                        <option value="Outreach Team">Outreach Team</option>
                        <option value="Prayer Warriors">Prayer Warriors</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="event-description" id="event-description-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300"></label>
                    <textarea id="event-description" name="description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2 flex justify-end space-x-3 mt-4">
                    <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                    <button type="button" id="event-modal-cancel-button" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"></button>
                    <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                    <button type="submit" id="event-modal-submit-button" class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Large Photo Modal -->
    <div id="large-photo-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-75">
        <!-- Removed transform transition-all scale-100 opacity-100 duration-300 ease-out from here -->
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-4 max-w-lg max-h-[90vh] overflow-y-auto modal-content">
            <button id="large-photo-close-button" class="absolute top-3 right-3 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white text-2xl font-bold focus:outline-none">
                &times;
            </button>
            <img id="large-photo-img" src="" alt="Enlarged Member Photo" class="max-w-full h-auto rounded-lg" />
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-50 dark:bg-opacity-75">
        <!-- Removed transform transition-all scale-100 opacity-100 duration-300 ease-out from here -->
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md modal-content">
            <h3 id="delete-confirm-title" class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-4"></h3>
            <p id="delete-confirm-message" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                <button id="delete-cancel-button" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"></button>
                <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                <button id="delete-confirm-button" class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"></button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-4 mt-8">
        <div class="container mx-auto text-center text-sm">
            &copy; 2025 All rights reserved by Sorn Vichea
        </div>
    </footer>

    <script>
        // Define translations for different languages
        const translations = {
            en: {
                dashboard: 'Dashboard',
                dashboardOverview: 'Dashboard Overview',
                welcomeDashboard: 'Welcome to your Church Management Dashboard! Here you\'ll find quick summaries and key metrics.',
                totalMembers: 'Total Members',
                activeMembers: 'Active Members',
                newBelievers: 'New Believers',
                service1Members: 'Service 1 Members',
                service2Members: 'Service 2 Members',
                upcomingEvents: 'Upcoming Events',
                recentDonations: 'Recent Donations',
                quickActions: 'Quick Actions',
                addNewMember: 'Add New Member',
                createNewEvent: 'Create New Event',
                recordDonation: 'Record Donation',
                members: 'Members',
                membersList: 'Members List',
                manageMembers: 'Display and manage church members here. Search for members by name or gender.',
                searchMembers: 'Search members...',
                allStatuses: 'All Statuses',
                active: 'Active',
                inactive: 'Inactive',
                pending: 'Pending',
                cellGroup: 'Cell group',
                parthWay: 'Parth-Way',
                newBeliever: 'New believer',
                visitor: 'Visitor',
                show: 'Show',
                importExcel: 'Import Excel',
                exportExcel: 'Export as Excel',
                exportPdf: 'Export as PDF',
                photo: 'Photo',
                name: 'Name',
                gender: 'Gender',
                phone: 'Phone',
                status: 'Status',
                actions: 'Actions',
                noMembersFound: 'No members found.',
                previous: 'Previous',
                next: 'Next',
                events: 'Events',
                eventsManagement: 'Events Management',
                planTrackEvents: 'Plan and track church events. This could include calendars, event registration, and attendance tracking.',
                upcomingEventsList: 'Upcoming events will be listed here...',
                sundayService: 'Sunday Service',
                youthGroupMeeting: 'Youth Group Meeting',
                communityOutreach: 'Community Outreach',
                reports: 'Reports',
                reportsAnalytics: 'Reports & Analytics',
                generateReports: 'Generate reports on membership, attendance, donations, and more.',
                selectReport: 'Select a report to generate:',
                membershipGrowthReport: 'Membership Growth Report',
                eventAttendanceReport: 'Event Attendance Report',
                financialSummaryReport: 'Financial Summary Report',
                monthlyComparisonReport: 'Monthly Membership Comparison Report',
                generateReport: 'Generate Report',
                profile: 'Profile',
                settings: 'Settings',
                logout: 'Logout',
                loading: 'Loading...',
                editMember: 'Edit Member',
                addMember: 'Add Member',
                profilePhoto: 'Profile Photo',
                firstName: 'First Name',
                lastName: 'Last Name',
                selectGender: 'Select Gender',
                dateOfBirth: 'Date of Birth',
                memberClass: 'Class',
                fromAddressOrigin: 'From (Address/Origin)',
                serviceEg: 'Service (e.g., Choir, Usher)',
                selectService: 'Select Service',
                phoneNumber: 'Phone Number',
                emergencyNumber: 'Emergency Number',
                facebookProfile: 'Facebook Profile',
                telegramID: 'Telegram ID',
                cancel: 'Cancel',
                saveChanges: 'Save Changes',
                memberDetails: 'Member Details',
                close: 'Close',
                confirmDeletion: 'Confirm Deletion',
                deleteConfirmation: 'Are you sure you want to delete member {memberName}? This action cannot be undone.',
                delete: 'Delete',
                language: 'Language',
                english: 'English',
                khmer: 'Khmer',
                eventName: 'Event Name',
                eventDate: 'Date',
                eventTime: 'Time',
                eventLocation: 'Location',
                eventDescription: 'Description',
                eventService: 'Service',
                eventTeam: 'Team',
                addEvent: 'Add Event',
                editEvent: 'Edit Event',
                noEventsFound: 'No events found.',
                systemName: 'NewLife Fellowship',
                reportTitleMonthlyComparison: 'Monthly Membership Comparison',
                reportMonth: 'Month',
                reportTotalMembers: 'Total Members',
                reportNewMembers: 'New Members',
                reportActiveMembers: 'Active Members',
            },
            km: {
                dashboard: 'ផ្ទាំងគ្រប់គ្រង',
                dashboardOverview: 'ទិដ្ឋភាពទូទៅនៃផ្ទាំងគ្រប់គ្រង',
                welcomeDashboard: 'សូមស្វាគមន៍មកកាន់ផ្ទាំងគ្រប់គ្រងព្រះវិហាររបស់អ្នក! នៅទីនេះអ្នកនឹងឃើញសេចក្តីសង្ខេប និងរង្វាស់សំខាន់ៗ។',
                totalMembers: 'សមាជិកសរុប',
                activeMembers: 'សមាជិកសកម្ម',
                newBelievers: 'អ្នកជឿថ្មី',
                service1Members: 'សមាជិកបម្រើការ ១',
                service2Members: 'សមាជិកបម្រើការ ២',
                upcomingEvents: 'ព្រឹត្តិការណ៍ខាងមុខ',
                recentDonations: 'វិភាគទានថ្មីៗ',
                quickActions: 'សកម្មភាពរហ័ស',
                addNewMember: 'បន្ថែមសមាជិកថ្មី',
                createNewEvent: 'បង្កើតព្រឹត្តិការណ៍ថ្មី',
                recordDonation: 'កត់ត្រាវិភាគទាន',
                members: 'សមាជិក',
                membersList: 'បញ្ជីសមាជិក',
                manageMembers: 'បង្ហាញនិងគ្រប់គ្រងសមាជិកព្រះវិហារនៅទីនេះ។ ស្វែងរកសមាជិកតាមឈ្មោះ ឬភេទ។',
                searchMembers: 'ស្វែងរកសមាជិក...',
                allStatuses: 'គ្រប់ស្ថានភាព',
                active: 'សកម្ម',
                inactive: 'អសកម្ម',
                pending: 'កំពុងរង់ចាំ',
                cellGroup: 'ក្រុមជំនុំ',
                parthWay: 'ផ្លូវនៃព្រះបន្ទូល',
                newBeliever: 'អ្នកជឿថ្មី',
                visitor: 'អ្នកទស្សនា',
                show: 'បង្ហាញ',
                importExcel: 'នាំចូល Excel',
                exportExcel: 'នាំចេញជា Excel',
                exportPdf: 'នាំចេញជា PDF',
                photo: 'រូបថត',
                name: 'ឈ្មោះ',
                gender: 'ភេទ',
                phone: 'ទូរស័ព្ទ',
                status: 'ស្ថានភាព',
                actions: 'សកម្មភាព',
                noMembersFound: 'រកមិនឃើញសមាជិកទេ។',
                previous: 'មុន',
                next: 'បន្ទាប់',
                events: 'ព្រឹត្តិការណ៍',
                eventsManagement: 'ការគ្រប់គ្រងព្រឹត្តិការណ៍',
                planTrackEvents: 'រៀបចំផែនការ និងតាមដានព្រឹត្តិការណ៍ព្រះវិហារ។ នេះអាចរួមបញ្ចូលប្រតិទិន ការចុះឈ្មោះព្រឹត្តិការណ៍ និងការតាមដានការចូលរួម។',
                upcomingEventsList: 'ព្រឹត្តិការណ៍ខាងមុខនឹងត្រូវបានចុះបញ្ជីនៅទីនេះ...',
                sundayService: 'ការថ្វាយបង្គំថ្ងៃអាទិត្យ',
                youthGroupMeeting: 'ការប្រជុំក្រុមយុវជន',
                communityOutreach: 'ការងារសង្គម',
                reports: 'របាយការណ៍',
                reportsAnalytics: 'របាយការណ៍ និងការវិភាគ',
                generateReports: 'បង្កើតរបាយការណ៍ស្តីពីសមាជិកភាព ការចូលរួម វិភាគទាន និងច្រើនទៀត។',
                selectReport: 'ជ្រើសរើសរបាយការណ៍ដើម្បីបង្កើត៖',
                membershipGrowthReport: 'របាយការណ៍កំណើនសមាជិកភាព',
                eventAttendanceReport: 'របាយការណ៍ការចូលរួមព្រឹត្តិការណ៍',
                financialSummaryReport: 'របាយការណ៍សង្ខេបហិរញ្ញវត្ថុ',
                monthlyComparisonReport: 'របាយការណ៍ប្រៀបធៀបសមាជិកភាពប្រចាំខែ',
                generateReport: 'បង្កើតរបាយការណ៍',
                profile: 'ប្រវត្តិរូប',
                settings: 'ការកំណត់',
                logout: 'ចេញ',
                loading: 'កំពុងផ្ទុក...',
                editMember: 'កែសម្រួលសមាជិក',
                addMember: 'បន្ថែមសមាជិក',
                profilePhoto: 'រូបថតប្រវត្តិរូប',
                firstName: 'នាមខ្លួន',
                lastName: 'ត្រកូល',
                selectGender: 'ជ្រើសរើសភេទ',
                dateOfBirth: 'ថ្ងៃខែឆ្នាំកំណើត',
                memberClass: 'ថ្នាក់',
                fromAddressOrigin: 'មកពី (អាសយដ្ឋាន/ស្រុកកំណើត)',
                serviceEg: 'ការបម្រើ (ឧទាហរណ៍៖ ក្រុមចម្រៀង, អ្នកបម្រើ)',
                selectService: 'ជ្រើសរើសការបម្រើ',
                phoneNumber: 'លេខទូរស័ព្ទ',
                emergencyNumber: 'លេខទូរស័ព្ទបន្ទាន់',
                facebookProfile: 'ទម្រង់ Facebook',
                telegramID: 'លេខសម្គាល់ Telegram',
                cancel: 'បោះបង់',
                saveChanges: 'រក្សាទុកការផ្លាស់ប្តូរ',
                memberDetails: 'ព័ត៌មានលម្អិតសមាជិក',
                close: 'បិទ',
                confirmDeletion: 'បញ្ជាក់ការលុប',
                deleteConfirmation: 'តើអ្នកប្រាកដជាចង់លុបសមាជិក {memberName} ទេ? សកម្មភាពនេះមិនអាចត្រឡប់វិញបានទេ។',
                delete: 'លុប',
                language: 'ភាសា',
                english: 'អង់គ្លេស',
                khmer: 'ខ្មែរ',
                eventName: 'ឈ្មោះព្រឹត្តិការណ៍',
                eventDate: 'កាលបរិច្ឆេទ',
                eventTime: 'ម៉ោង',
                eventLocation: 'ទីតាំង',
                eventDescription: 'ការពិពណ៌នា',
                eventService: 'ការបម្រើ',
                eventTeam: 'ក្រុម',
                addEvent: 'បន្ថែមព្រឹត្តិការណ៍',
                editEvent: 'កែសម្រួលព្រឹត្តិការណ៍',
                noEventsFound: 'រកមិនឃើញព្រឹត្តិការណ៍ទេ។',
                systemName: 'NewLife Fellowship',
                reportTitleMonthlyComparison: 'Monthly Membership Comparison',
                reportMonth: 'ខែ',
                reportTotalMembers: 'សមាជិកសរុប',
                reportNewMembers: 'សមាជិកថ្មី',
                reportActiveMembers: 'សមាជិកសកម្ម',
            },
        };

        // Global state object
        const appState = {
            activeSection: 'dashboard',
            theme: 'light',
            memberSearchQuery: '',
            showAddMemberModal: false,
            statusFilter: 'All',
            membersPerPage: 10,
            currentPage: 1,
            fileInputKey: Date.now(), // For re-rendering file input
            selectedMember: null,
            showPhotoModal: false,
            largePhotoUrl: '',
            editingMember: null,
            showDeleteConfirmModal: false,
            memberToDelete: null,
            isLoading: true,
            isJsPdfLoaded: false,
            language: 'en',
            events: [
                { id: 1, name: 'Sunday Service', date: '2025-07-21', time: '09:00 AM', location: 'Main Hall', description: 'Weekly Sunday worship service.', service: 'Worship', team: 'Pastoral Team' },
                { id: 2, name: 'Youth Group Meeting', date: '2025-07-25', time: '06:00 PM', location: 'Youth Room', description: 'Bible study and fellowship for youth.', service: 'Youth Ministry', team: 'Youth Leaders' },
                { id: 3, name: 'Community Outreach', date: '2025-08-03', time: '02:00 PM', location: 'City Park', description: 'Volunteering and community support.', service: 'Community Service', team: 'Outreach Team' },
                { id: 4, name: 'Prayer Night', date: '2025-08-10', time: '07:00 PM', location: 'Sanctuary', description: 'An evening dedicated to prayer and intercession.', service: 'Prayer Ministry', team: 'Prayer Warriors' },
            ],
            showAddEventModal: false,
            newEvent: { name: '', date: '', time: '', location: '', description: '', service: '', team: '' },
            editingEvent: null,
            members: [
                { id: 1, name: 'John Doe', status: 'Active', gender: 'Male', phone: '123-456-7890', service: 'Service 1', photo: 'https://placehold.co/150x150/aabbcc/ffffff?text=JD', facebook: 'johndoe', telegram: 'johndoe_tg', lastName: 'Doe', firstName: 'John', dateOfBirth: '1990-01-15', memberClass: 'Adult', from: 'Phnom Penh', emergencyNumber: '987-654-3210' },
                { id: 2, name: 'Jane Smith', status: 'Active', gender: 'Female', phone: '098-765-4321', service: 'Service 2', photo: 'https://placehold.co/150x150/ccbbaa/ffffff?text=JS', facebook: 'janesmith', telegram: 'janesmith_tg', lastName: 'Smith', firstName: 'Jane', dateOfBirth: '1985-05-20', memberClass: 'Adult', from: 'Siem Reap', emergencyNumber: '123-123-1234' },
                { id: 3, name: 'Peter Jones', status: 'Inactive', gender: 'Male', phone: '111-222-3333', service: 'Other', photo: 'https://placehold.co/150x150/aaccbb/ffffff?text=PJ', facebook: '', telegram: '', lastName: 'Jones', firstName: 'Peter', dateOfBirth: '1978-11-10', memberClass: 'Adult', from: 'Battambang', emergencyNumber: '456-789-0123' },
                { id: 4, name: 'Alice Brown', status: 'New believer', gender: 'Female', phone: '444-555-6666', service: 'Service 1', photo: 'https://placehold.co/150x150/bbaacc/ffffff?text=AB', facebook: 'alicebrown', telegram: 'alicebrown_tg', lastName: 'Brown', firstName: 'Alice', dateOfBirth: '1995-03-25', memberClass: 'Youth', from: 'Kampot', emergencyNumber: '789-012-3456' },
                { id: 5, name: 'Bob White', status: 'Active', gender: 'Male', phone: '777-888-9999', service: 'Service 1', photo: 'https://placehold.co/150x150/ccddaa/ffffff?text=BW', facebook: '', telegram: '', lastName: 'White', firstName: 'Bob', dateOfBirth: '1980-08-01', memberClass: 'Adult', from: 'Sihanoukville', emergencyNumber: '012-345-6789' },
                { id: 6, name: 'Charlie Green', status: 'Cell group', gender: 'Male', phone: '222-333-4444', service: 'Service 2', photo: 'https://placehold.co/150x150/ddeecc/ffffff?text=CG', facebook: 'charliegreen', telegram: 'charliegreen_tg', lastName: 'Green', firstName: 'Charlie', dateOfBirth: '1992-02-28', memberClass: 'Adult', from: 'Kandal', emergencyNumber: '345-678-9012' },
                { id: 7, name: 'Diana Blue', status: 'New believer', gender: 'Female', phone: '555-666-7777', service: 'Other', photo: 'https://placehold.co/150x150/eeccdd/ffffff?text=DB', facebook: '', telegram: '', lastName: 'Blue', firstName: 'Diana', dateOfBirth: '2000-07-07', memberClass: 'Youth', from: 'Takeo', emergencyNumber: '678-901-2345' },
                { id: 8, name: 'Eve Black', status: 'Visitor', gender: 'Female', phone: '999-888-7777', service: 'Service 1', photo: 'https://placehold.co/150x150/ffccaa/ffffff?text=EB', facebook: '', telegram: '', lastName: 'Black', firstName: 'Eve', dateOfBirth: '1975-12-12', memberClass: 'Adult', from: 'Prey Veng', emergencyNumber: '901-234-5678' },
                { id: 9, name: 'Frank Gray', status: 'Active', gender: 'Male', phone: '123-123-1234', service: 'Service 2', photo: 'https://placehold.co/150x150/aaffcc/ffffff?text=FG', facebook: 'frankgray', telegram: '', lastName: 'Gray', firstName: 'Frank', dateOfBirth: '1988-09-09', memberClass: 'Adult', from: 'Pursat', emergencyNumber: '234-567-8901' },
                { id: 10, name: 'Grace Hall', status: 'New believer', gender: 'Female', phone: '456-456-4567', service: 'Other', photo: 'https://placehold.co/150x150/ccffaa/ffffff?text=GH', facebook: '', telegram: 'gracehall_tg', lastName: 'Hall', firstName: 'Grace', dateOfBirth: '1998-04-04', memberClass: 'Youth', from: 'Svay Rieng', emergencyNumber: '567-890-1234' },
                { id: 11, name: 'Henry King', status: 'Active', gender: 'Male', phone: '789-789-7890', service: 'Service 1', photo: 'https://placehold.co/150x150/eeffcc/ffffff?text=HK', facebook: '', telegram: '', lastName: 'King', firstName: 'Henry', dateOfBirth: '1983-06-18', memberClass: 'Adult', from: 'Koh Kong', emergencyNumber: '890-123-4567' },
                { id: 12, name: 'Ivy Lee', status: 'Cell group', gender: 'Female', phone: '101-202-3030', service: 'Service 2', photo: 'https://placehold.co/150x150/ffddcc/ffffff?text=IL', facebook: 'ivylee', telegram: '', lastName: 'Lee', firstName: 'Ivy', dateOfBirth: '1991-10-30', memberClass: 'Adult', from: 'Oddar Meanchey', emergencyNumber: '123-456-7890' },
                { id: 13, name: 'Jack Green', status: 'Active', gender: 'Male', phone: '321-654-9870', service: 'Service 1', photo: 'https://placehold.co/150x150/aaccff/ffffff?text=JG', facebook: '', telegram: 'jackgreen_tg', lastName: 'Green', firstName: 'Jack', dateOfBirth: '1987-01-01', memberClass: 'Adult', from: 'Banteay Meanchey', emergencyNumber: '098-765-4321' },
                { id: 14, name: 'Karen Red', status: 'Parth-Way', gender: 'Female', phone: '654-321-0987', service: 'Other', photo: 'https://placehold.co/150x150/ccffdd/ffffff?text=KR', facebook: '', telegram: '', lastName: 'Red', firstName: 'Karen', dateOfBirth: '1993-02-14', memberClass: 'Youth', from: 'Kep', emergencyNumber: '111-222-3333' },
                { id: 15, name: 'Liam Blue', status: 'Active', gender: 'Male', phone: '987-654-3210', service: 'Service 2', photo: 'https://placehold.co/150x150/eeccff/ffffff?text=LB', facebook: 'liamblue', telegram: '', lastName: 'Blue', firstName: 'Liam', dateOfBirth: '1989-07-22', memberClass: 'Adult', from: 'Pailin', emergencyNumber: '444-555-6666' },
            ],
            newMember: {
                lastName: '', firstName: '', gender: '', dateOfBirth: '', memberClass: '',
                status: '', from: '', service: '', phoneNumber: '', emergencyNumber: '',
                photo: '', facebook: '', telegram: '',
            },
            selectedReportType: '',
            generatedReportData: null,
            monthlyMembershipData: [
                { month: 'Jan 2025', totalMembers: 150, newMembers: 10, activeMembers: 140 },
                { month: 'Feb 2025', totalMembers: 155, newMembers: 8, activeMembers: 145 },
                { month: 'Mar 2025', totalMembers: 160, newMembers: 12, activeMembers: 150 },
                { month: 'Apr 2025', totalMembers: 162, newMembers: 5, activeMembers: 155 },
                { month: 'May 2025', totalMembers: 168, newMembers: 10, activeMembers: 160 },
                { month: 'Jun 2025', totalMembers: 175, newMembers: 15, activeMembers: 165 },
                { month: 'Jul 2025', totalMembers: 180, newMembers: 10, activeMembers: 170 },
            ],
        };

        // Utility function to update state and re-render
        function setState(newState, callback) {
            Object.assign(appState, newState);
            render();
            if (callback) callback();
        }

        // Function to apply theme classes to the body
        function applyTheme() {
            if (appState.theme === 'dark') {
                document.documentElement.classList.add('dark');
                document.body.classList.remove('bg-gray-100', 'text-gray-900');
                document.body.classList.add('bg-gray-900', 'text-gray-100');
                document.getElementById('theme-icon-light').classList.add('hidden');
                document.getElementById('theme-icon-dark').classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('bg-gray-900', 'text-gray-100');
                document.body.classList.add('bg-gray-100', 'text-gray-900');
                document.getElementById('theme-icon-light').classList.remove('hidden');
                document.getElementById('theme-icon-dark').classList.add('hidden');
            }
        }

        // Function to update translations
        function updateTranslations() {
            const currentTranslations = translations[appState.language];

            document.getElementById('system-name').textContent = currentTranslations.systemName;
            document.getElementById('profile-link-text').textContent = currentTranslations.profile;
            document.getElementById('settings-link-text').textContent = currentTranslations.settings;
            document.getElementById('logout-link-text').textContent = currentTranslations.logout;
            document.getElementById('dashboard-nav-text').textContent = currentTranslations.dashboard;
            document.getElementById('members-nav-text').textContent = currentTranslations.members;
            document.getElementById('events-nav-text').textContent = currentTranslations.events;
            document.getElementById('reports-nav-text').textContent = currentTranslations.reports;
            document.getElementById('loading-text').textContent = currentTranslations.loading;

            // Member modal translations
            document.getElementById('profile-photo-label').textContent = currentTranslations.profilePhoto;
            document.getElementById('first-name-label').textContent = currentTranslations.firstName;
            document.getElementById('last-name-label').textContent = currentTranslations.lastName;
            document.getElementById('gender-label').textContent = currentTranslations.gender;
            document.getElementById('select-gender-option').textContent = currentTranslations.selectGender;
            document.getElementById('gender-male-option').textContent = currentTranslations.gender === 'ភេទ' ? 'ប្រុស' : 'Male';
            document.getElementById('gender-female-option').textContent = currentTranslations.gender === 'ភេទ' ? 'ស្រី' : 'Female';
            document.getElementById('gender-other-option').textContent = currentTranslations.gender === 'ភេទ' ? 'ផ្សេងៗ' : 'Other';
            document.getElementById('date-of-birth-label').textContent = currentTranslations.dateOfBirth;
            document.getElementById('member-class-label').textContent = currentTranslations.memberClass;
            document.getElementById('status-label').textContent = currentTranslations.status;
            document.getElementById('all-statuses-option').textContent = currentTranslations.allStatuses;
            document.getElementById('status-active-option').textContent = currentTranslations.active;
            document.getElementById('status-inactive-option').textContent = currentTranslations.inactive;
            document.getElementById('status-pending-option').textContent = currentTranslations.pending;
            document.getElementById('status-cell-group-option').textContent = currentTranslations.cellGroup;
            document.getElementById('status-parth-way-option').textContent = currentTranslations.parthWay;
            document.getElementById('status-new-believer-option').textContent = currentTranslations.newBeliever;
            document.getElementById('status-visitor-option').textContent = currentTranslations.visitor;
            document.getElementById('from-address-origin-label').textContent = currentTranslations.fromAddressOrigin;
            document.getElementById('service-eg-label').textContent = currentTranslations.serviceEg;
            document.getElementById('select-service-option').textContent = currentTranslations.selectService;
            document.getElementById('phone-number-label').textContent = currentTranslations.phoneNumber;
            document.getElementById('emergency-number-label').textContent = currentTranslations.emergencyNumber;
            document.getElementById('facebook-profile-label').textContent = currentTranslations.facebookProfile;
            document.getElementById('telegram-id-label').textContent = currentTranslations.telegramID;
            document.getElementById('member-modal-cancel-button').textContent = currentTranslations.cancel;

            // Member details modal translations
            document.getElementById('details-first-name-label').textContent = currentTranslations.firstName + ':';
            document.getElementById('details-last-name-label').textContent = currentTranslations.lastName + ':';
            document.getElementById('details-gender-label').textContent = currentTranslations.gender + ':';
            document.getElementById('details-date-of-birth-label').textContent = currentTranslations.dateOfBirth + ':';
            document.getElementById('details-member-class-label').textContent = currentTranslations.memberClass + ':';
            document.getElementById('details-status-label').textContent = currentTranslations.status + ':';
            document.getElementById('details-from-address-origin-label').textContent = currentTranslations.fromAddressOrigin + ':';
            document.getElementById('details-service-label').textContent = currentTranslations.serviceEg.split(' ')[0] + ':';
            document.getElementById('details-phone-number-label').textContent = currentTranslations.phoneNumber + ':';
            document.getElementById('details-emergency-number-label').textContent = currentTranslations.emergencyNumber + ':';
            document.getElementById('details-facebook-profile-label').textContent = currentTranslations.facebookProfile + ':';
            document.getElementById('details-telegram-id-label').textContent = currentTranslations.telegramID + ':';
            document.getElementById('member-details-close-button').textContent = currentTranslations.close;

            // Delete confirmation modal translations
            document.getElementById('delete-confirm-title').textContent = currentTranslations.confirmDeletion;
            document.getElementById('delete-cancel-button').textContent = currentTranslations.cancel;
            document.getElementById('delete-confirm-button').textContent = currentTranslations.delete;

            // Event modal translations
            document.getElementById('event-name-label').textContent = currentTranslations.eventName;
            document.getElementById('event-date-label').textContent = currentTranslations.eventDate;
            document.getElementById('event-time-label').textContent = currentTranslations.eventTime;
            document.getElementById('event-location-label').textContent = currentTranslations.eventLocation;
            document.getElementById('event-service-label').textContent = currentTranslations.eventService;
            document.getElementById('event-team-label').textContent = currentTranslations.eventTeam;
            document.getElementById('event-description-label').textContent = currentTranslations.eventDescription;
            document.getElementById('event-modal-cancel-button').textContent = currentTranslations.cancel;
        }

        // --- Render Functions for Sections ---
        function renderDashboard() {
            const contentArea = document.getElementById('content-area');
            const currentTranslations = translations[appState.language];

            const totalMembers = appState.members.length;
            const activeMembersCount = appState.members.filter(member => member.status === 'Active').length;
            const newBelieverCount = appState.members.filter(member => member.status === 'New believer').length;
            const service1Count = appState.members.filter(member => member.service === 'Service 1').length;
            const service2Count = appState.members.filter(member => member.service === 'Service 2').length;
            const eventCount = appState.events.length;

            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4">${currentTranslations.dashboardOverview}</h2>
                <p class="text-gray-600 dark:text-gray-300">${currentTranslations.welcomeDashboard}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-6">
                    <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-blue-800 dark:text-blue-200">${currentTranslations.totalMembers}</h3>
                        <p class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-2">${totalMembers}</p>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-purple-800 dark:text-purple-200">${currentTranslations.activeMembers}</h3>
                        <p class="text-3xl font-bold text-purple-600 dark:text-purple-400 mt-2">${activeMembersCount}</p>
                    </div>
                    <div class="bg-pink-50 dark:bg-pink-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-pink-800 dark:text-pink-200">${currentTranslations.newBelievers}</h3>
                        <p class="text-3xl font-bold text-pink-600 dark:text-pink-400 mt-2">${newBelieverCount}</p>
                    </div>
                    <div class="bg-indigo-50 dark:bg-indigo-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-indigo-800 dark:text-indigo-200">${currentTranslations.service1Members}</h3>
                        <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mt-2">${service1Count}</p>
                    </div>
                    <div class="bg-teal-50 dark:bg-teal-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-teal-800 dark:text-teal-200">${currentTranslations.service2Members}</h3>
                        <p class="text-3xl font-bold text-teal-600 dark:text-teal-400 mt-2">${service2Count}</p>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-green-800 dark:text-green-200">${currentTranslations.upcomingEvents}</h3>
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400 mt-2">${eventCount}</p>
                    </div>
                </div>
                <div class="mt-6 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="text-xl font-semibold mb-2">${currentTranslations.quickActions}</h3>
                    <ul class="list-disc list-inside mt-2 text-gray-700 dark:text-gray-200">
                        <li><button id="add-new-member-quick-action" class="text-indigo-600 dark:text-indigo-400 hover:underline">${currentTranslations.addNewMember}</button></li>
                        <li><button id="create-new-event-quick-action" class="text-indigo-600 dark:text-indigo-400 hover:underline">${currentTranslations.createNewEvent}</button></li>
                    </ul>
                </div>
            `;
            document.getElementById('add-new-member-quick-action').onclick = () => {
                setState({ activeSection: 'members', showAddMemberModal: true, editingMember: null });
            };
            document.getElementById('create-new-event-quick-action').onclick = () => {
                setState({ activeSection: 'events', showAddEventModal: true, editingEvent: null });
            };
        }

        function renderMembers() {
            const contentArea = document.getElementById('content-area');
            const currentTranslations = translations[appState.language];

            // Filtered members based on search query and status filter
            const filteredAndSearchedMembers = appState.members.filter(member => {
                const matchesSearch = member.name.toLowerCase().includes(appState.memberSearchQuery.toLowerCase()) ||
                                      member.gender.toLowerCase().includes(appState.memberSearchQuery.toLowerCase());
                const matchesStatus = appState.statusFilter === 'All' || member.status === appState.statusFilter;
                return matchesSearch && matchesStatus;
            });

            // Pagination calculations
            const totalPages = Math.ceil(filteredAndSearchedMembers.length / appState.membersPerPage);
            const indexOfLastMember = appState.currentPage * appState.membersPerPage;
            const indexOfFirstMember = indexOfLastMember - appState.membersPerPage;
            const currentMembers = filteredAndSearchedMembers.slice(indexOfFirstMember, indexOfLastMember);

            let memberRowsHtml = '';
            if (currentMembers.length > 0) {
                memberRowsHtml = currentMembers.map(member => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button data-member-id="${member.id}" class="view-photo-button focus:outline-none">
                                ${member.photo ?
                                    `<img src="${member.photo}" alt="${member.name}" class="h-10 w-10 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/ffffff?text=N/A';" />` :
                                    `<div class="h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center text-gray-500 dark:text-gray-300 text-xs">No Photo</div>`
                                }
                            </button>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button data-member-id="${member.id}" class="view-details-button text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:underline focus:outline-none">
                                ${member.name}
                            </button>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm text-gray-700 dark:text-gray-300">${member.gender}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm text-gray-700 dark:text-gray-300">${member.phone}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${member.status === 'Active' ? 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100' : 'bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100'}">
                                ${member.status === 'Active' ? currentTranslations.active :
                                  member.status === 'Inactive' ? currentTranslations.inactive :
                                  member.status === 'Pending' ? currentTranslations.pending :
                                  member.status === 'Cell group' ? currentTranslations.cellGroup :
                                  member.status === 'Parth-Way' ? currentTranslations.parthWay :
                                  member.status === 'New believer' ? currentTranslations.newBeliever :
                                  member.status === 'Visitor' ? currentTranslations.visitor :
                                  member.status}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium flex space-x-2">
                            <!-- Removed transition duration-150 -->
                            <button data-member-id="${member.id}" class="edit-member-button text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600" title="${currentTranslations.editMember}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.828-2.828z" />
                                </svg>
                            </button>
                            <!-- Removed transition duration-150 -->
                            <button data-member-id="${member.id}" class="delete-member-button text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600" title="${currentTranslations.delete}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                memberRowsHtml = `
                    <tr>
                        <td colspan="6" class="px-4 py-3 whitespace-nowrap text-center text-sm text-gray-500 dark:text-gray-400">
                            ${currentTranslations.noMembersFound}
                        </td>
                    </tr>
                `;
            }

            let paginationHtml = '';
            if (totalPages > 1) {
                const pageButtons = Array.from({ length: totalPages }, (_, i) => i + 1).map(page => `
                    <li>
                        <button data-page="${page}" class="paginate-button px-3 py-2 leading-tight ${appState.currentPage === page ? 'text-indigo-600 bg-indigo-50 border border-indigo-300 dark:bg-indigo-700 dark:border-indigo-600 dark:text-white' : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'}">
                            ${page}
                        </button>
                    </li>
                `).join('');

                paginationHtml = `
                    <nav class="mt-4 flex justify-center" aria-label="Pagination">
                        <ul class="flex items-center -space-x-px">
                            <li>
                                <button id="paginate-previous" class="px-3 py-2 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white ${appState.currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${appState.currentPage === 1 ? 'disabled' : ''}>
                                    ${currentTranslations.previous}
                                </button>
                            </li>
                            ${pageButtons}
                            <li>
                                <button id="paginate-next" class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white ${appState.currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${appState.currentPage === totalPages ? 'disabled' : ''}>
                                    ${currentTranslations.next}
                                </button>
                            </li>
                        </ul>
                    </nav>
                `;
            }

            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4">${currentTranslations.membersList}</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-4">${currentTranslations.manageMembers}</p>

                <div class="flex flex-col sm:flex-row gap-4 mb-6 items-center">
                    <input
                        type="text"
                        id="member-search-input"
                        placeholder="${currentTranslations.searchMembers}"
                        class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        value="${appState.memberSearchQuery}"
                    />
                    <select
                        id="status-filter-select"
                        class="p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    >
                        <option value="All">${currentTranslations.allStatuses}</option>
                        <option value="Active" ${appState.statusFilter === 'Active' ? 'selected' : ''}>${currentTranslations.active}</option>
                        <option value="Inactive" ${appState.statusFilter === 'Inactive' ? 'selected' : ''}>${currentTranslations.inactive}</option>
                        <option value="Pending" ${appState.statusFilter === 'Pending' ? 'selected' : ''}>${currentTranslations.pending}</option>
                        <option value="Cell group" ${appState.statusFilter === 'Cell group' ? 'selected' : ''}>${currentTranslations.cellGroup}</option>
                        <option value="Parth-Way" ${appState.statusFilter === 'Parth-Way' ? 'selected' : ''}>${currentTranslations.parthWay}</option>
                        <option value="New believer" ${appState.statusFilter === 'New believer' ? 'selected' : ''}>${currentTranslations.newBeliever}</option>
                        <option value="Visitor" ${appState.statusFilter === 'Visitor' ? 'selected' : ''}>${currentTranslations.visitor}</option>
                    </select>
                    <select
                        id="members-per-page-select"
                        class="p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    >
                        <option value="5" ${appState.membersPerPage === 5 ? 'selected' : ''}>${currentTranslations.show} 5</option>
                        <option value="10" ${appState.membersPerPage === 10 ? 'selected' : ''}>${currentTranslations.show} 10</option>
                        <option value="20" ${appState.membersPerPage === 20 ? 'selected' : ''}>${currentTranslations.show} 20</option>
                        <option value="50" ${appState.membersPerPage === 50 ? 'selected' : ''}>${currentTranslations.show} 50</option>
                        <option value="100" ${appState.membersPerPage === 100 ? 'selected' : ''}>${currentTranslations.show} 100</option>
                        <option value="${appState.members.length}" ${appState.membersPerPage === appState.members.length ? 'selected' : ''}>${currentTranslations.show} All</option>
                    </select>
                    <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                    <button id="add-new-member-button" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 hover:shadow-lg">
                        ${currentTranslations.addNewMember}
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 mb-6 justify-end">
                    <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                    <label for="importExcel" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg shadow-md hover:bg-gray-300 hover:shadow-lg cursor-pointer text-center">
                        ${currentTranslations.importExcel}
                        <input type="file" id="importExcel" accept=".xlsx, .xls" class="hidden" />
                    </label>
                    <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                    <button id="export-excel-button" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 hover:shadow-lg">
                        ${currentTranslations.exportExcel}
                    </button>
                    <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                    <button id="export-pdf-button" class="px-6 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 hover:shadow-lg">
                        ${currentTranslations.exportPdf}
                    </button>
                </div>

                <div class="overflow-x-auto border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.photo}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.name}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.gender}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.phone}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.status}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.actions}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                            ${memberRowsHtml}
                        </tbody>
                    </table>
                </div>
                ${paginationHtml}
            `;

            // Attach event listeners after rendering HTML
            document.getElementById('member-search-input').oninput = (e) => {
                setState({ memberSearchQuery: e.target.value, currentPage: 1 });
            };
            document.getElementById('status-filter-select').onchange = (e) => {
                setState({ statusFilter: e.target.value, currentPage: 1 });
            };
            document.getElementById('members-per-page-select').onchange = (e) => {
                setState({ membersPerPage: Number(e.target.value), currentPage: 1 });
            };
            document.getElementById('add-new-member-button').onclick = () => {
                setState({ showAddMemberModal: true, editingMember: null, newMember: { lastName: '', firstName: '', gender: '', dateOfBirth: '', memberClass: '', status: '', from: '', service: '', phoneNumber: '', emergencyNumber: '', photo: '', facebook: '', telegram: '' } });
            };
            document.getElementById('importExcel').onchange = handleImportExcel;
            document.getElementById('export-excel-button').onclick = handleExportExcel;
            document.getElementById('export-pdf-button').onclick = handleExportPdf;

            document.querySelectorAll('.view-photo-button').forEach(button => {
                button.onclick = (e) => {
                    const memberId = parseInt(e.currentTarget.dataset.memberId);
                    const member = appState.members.find(m => m.id === memberId);
                    if (member && member.photo) {
                        setState({ showPhotoModal: true, largePhotoUrl: member.photo });
                    } else {
                        setState({ showPhotoModal: true, largePhotoUrl: 'https://placehold.co/400x400/cccccc/ffffff?text=Image+Not+Available' });
                    }
                };
            });
            document.querySelectorAll('.view-details-button').forEach(button => {
                button.onclick = (e) => {
                    const memberId = parseInt(e.currentTarget.dataset.memberId);
                    const member = appState.members.find(m => m.id === memberId);
                    if (member) {
                        setState({ selectedMember: member });
                    }
                };
            });
            document.querySelectorAll('.edit-member-button').forEach(button => {
                button.onclick = (e) => {
                    const memberId = parseInt(e.currentTarget.dataset.memberId);
                    const member = appState.members.find(m => m.id === memberId);
                    if (member) {
                        setState({ editingMember: { ...member }, showAddMemberModal: true });
                    }
                };
            });
            document.querySelectorAll('.delete-member-button').forEach(button => {
                button.onclick = (e) => {
                    const memberId = parseInt(e.currentTarget.dataset.memberId);
                    const member = appState.members.find(m => m.id === memberId);
                    if (member) {
                        setState({ memberToDelete: member, showDeleteConfirmModal: true });
                    }
                };
            });

            document.querySelectorAll('.paginate-button').forEach(button => {
                button.onclick = (e) => {
                    setState({ currentPage: parseInt(e.target.dataset.page) });
                };
            });
            const paginatePrevButton = document.getElementById('paginate-previous');
            if (paginatePrevButton) {
                paginatePrevButton.onclick = () => setState({ currentPage: appState.currentPage - 1 });
            }
            const paginateNextButton = document.getElementById('paginate-next');
            if (paginateNextButton) {
                paginateNextButton.onclick = () => setState({ currentPage: appState.currentPage + 1 });
            }
        }

        function renderEvents() {
            const contentArea = document.getElementById('content-area');
            const currentTranslations = translations[appState.language];

            let eventRowsHtml = '';
            if (appState.events.length > 0) {
                eventRowsHtml = appState.events.map(event => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${event.name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.date}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.time}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.location}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.service}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${event.team}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300 max-w-xs truncate">${event.description}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <!-- Removed transition duration-150 -->
                            <button data-event-id="${event.id}" class="edit-event-button text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600" title="${currentTranslations.editEvent}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.828-2.828z" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                eventRowsHtml = `
                    <tr>
                        <td colspan="8" class="px-4 py-3 whitespace-nowrap text-center text-sm text-gray-500 dark:text-gray-400">
                            ${currentTranslations.noEventsFound}
                        </td>
                    </tr>
                `;
            }

            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4">${currentTranslations.eventsManagement}</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-4">${currentTranslations.planTrackEvents}</p>

                <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                <button id="create-new-event-button" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 hover:shadow-lg mb-6">
                    ${currentTranslations.createNewEvent}
                </button>

                <div class="overflow-x-auto border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.eventName}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.eventDate}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.eventTime}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.eventLocation}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.eventService}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.eventTeam}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.eventDescription}</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.actions}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                            ${eventRowsHtml}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('create-new-event-button').onclick = () => {
                setState({ showAddEventModal: true, editingEvent: null, newEvent: { name: '', date: '', time: '', location: '', description: '', service: '', team: '' } });
            };
            document.querySelectorAll('.edit-event-button').forEach(button => {
                button.onclick = (e) => {
                    const eventId = parseInt(e.currentTarget.dataset.eventId);
                    const event = appState.events.find(ev => ev.id === eventId);
                    if (event) {
                        setState({ editingEvent: { ...event }, showAddEventModal: true });
                    }
                };
            });
        }

        function renderReports() {
            const contentArea = document.getElementById('content-area');
            const currentTranslations = translations[appState.language];

            let reportDisplayHtml = '';
            if (appState.generatedReportData) {
                if (appState.selectedReportType === 'Monthly Membership Comparison' && Array.isArray(appState.generatedReportData)) {
                    const tableRows = appState.generatedReportData.map(data => `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${data.month}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${data.totalMembers}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${data.newMembers}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${data.activeMembers}</td>
                        </tr>
                    `).join('');

                    reportDisplayHtml = `
                        <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600">
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">${currentTranslations.reportTitleMonthlyComparison}</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                    <thead class="bg-gray-100 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.reportMonth}</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.reportTotalMembers}</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.reportNewMembers}</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${currentTranslations.reportActiveMembers}</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    reportDisplayHtml = `
                        <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600">
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">${appState.selectedReportType}</h3>
                            <p class="text-gray-700 dark:text-gray-300">${appState.generatedReportData.message}</p>
                        </div>
                    `;
                }
            }

            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4">${currentTranslations.reportsAnalytics}</h2>
                <p class="text-gray-600 dark:text-gray-300">${currentTranslations.generateReports}</p>
                <div class="mt-6 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <label for="report-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${currentTranslations.selectReport}</label>
                    <select
                        id="report-select"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500"
                    >
                        <option value="">-- ${currentTranslations.selectReport} --</option>
                        <option value="Membership Growth Report" ${appState.selectedReportType === 'Membership Growth Report' ? 'selected' : ''}>${currentTranslations.membershipGrowthReport}</option>
                        <option value="Event Attendance Report" ${appState.selectedReportType === 'Event Attendance Report' ? 'selected' : ''}>${currentTranslations.eventAttendanceReport}</option>
                        <option value="Financial Summary Report" ${appState.selectedReportType === 'Financial Summary Report' ? 'selected' : ''}>${currentTranslations.financialSummaryReport}</option>
                        <option value="Monthly Membership Comparison" ${appState.selectedReportType === 'Monthly Membership Comparison' ? 'selected' : ''}>${currentTranslations.monthlyComparisonReport}</option>
                    </select>
                    <!-- Removed transition duration-300 ease-in-out transform hover:-translate-y-0.5 -->
                    <button id="generate-report-button" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 hover:shadow-lg mt-6 ${!appState.selectedReportType ? 'opacity-50 cursor-not-allowed' : ''}" ${!appState.selectedReportType ? 'disabled' : ''}>
                        ${currentTranslations.generateReport}
                    </button>
                </div>
                ${reportDisplayHtml}
            `;

            document.getElementById('report-select').onchange = (e) => {
                setState({ selectedReportType: e.target.value, generatedReportData: null });
            };
            document.getElementById('generate-report-button').onclick = handleGenerateReport;
        }

        function renderSettings() {
            const contentArea = document.getElementById('content-area');
            const currentTranslations = translations[appState.language];

            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4">${currentTranslations.settings}</h2>
                <div class="mt-6 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="text-xl font-semibold mb-2">${currentTranslations.language}</h3>
                    <div class="flex items-center gap-4">
                        <label for="language-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">${currentTranslations.language}:</label>
                        <select
                            id="language-select"
                            class="mt-1 block w-auto p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500"
                        >
                            <option value="en" ${appState.language === 'en' ? 'selected' : ''}>${currentTranslations.english}</option>
                            <option value="km" ${appState.language === 'km' ? 'selected' : ''}>${currentTranslations.khmer}</option>
                        </select>
                    </div>
                </div>
            `;
            document.getElementById('language-select').onchange = (e) => {
                setState({ language: e.target.value });
            };
        }

        // --- Render Functions for Modals ---

        function renderAddEditMemberModal() {
            const modal = document.getElementById('add-edit-member-modal');
            const form = document.getElementById('member-form');
            const title = document.getElementById('member-modal-title');
            const submitButton = document.getElementById('member-modal-submit-button');
            const photoPreview = document.getElementById('member-photo-preview');
            const photoPlaceholder = document.getElementById('member-photo-placeholder');
            const photoUpload = document.getElementById('member-photo-upload');

            const currentTranslations = translations[appState.language];

            if (appState.showAddMemberModal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex'); // Ensure it's flex for centering
                document.body.classList.add('overflow-hidden'); // Prevent body scroll

                if (appState.editingMember) {
                    title.textContent = currentTranslations.editMember;
                    submitButton.textContent = currentTranslations.saveChanges;
                    // Populate form fields
                    document.getElementById('member-firstName').value = appState.editingMember.firstName;
                    document.getElementById('member-lastName').value = appState.editingMember.lastName;
                    document.getElementById('member-gender').value = appState.editingMember.gender;
                    document.getElementById('member-dateOfBirth').value = appState.editingMember.dateOfBirth;
                    document.getElementById('member-memberClass').value = appState.editingMember.memberClass;
                    document.getElementById('member-status').value = appState.editingMember.status;
                    document.getElementById('member-from').value = appState.editingMember.from;
                    document.getElementById('member-service').value = appState.editingMember.service;
                    document.getElementById('member-phoneNumber').value = appState.editingMember.phone;
                    document.getElementById('member-emergencyNumber').value = appState.editingMember.emergencyNumber;
                    document.getElementById('member-facebook').value = appState.editingMember.facebook;
                    document.getElementById('member-telegram').value = appState.editingMember.telegram;

                    if (appState.editingMember.photo) {
                        photoPreview.src = appState.editingMember.photo;
                        photoPreview.classList.remove('hidden');
                        photoPlaceholder.classList.add('hidden');
                    } else {
                        photoPreview.classList.add('hidden');
                        photoPlaceholder.classList.remove('hidden');
                    }
                } else {
                    title.textContent = currentTranslations.addMember;
                    submitButton.textContent = currentTranslations.addMember;
                    form.reset(); // Clear form for new member
                    photoPreview.classList.add('hidden');
                    photoPlaceholder.classList.remove('hidden');
                    photoPreview.src = ''; // Clear previous photo
                }

                form.onsubmit = handleMemberFormSubmit;
                photoUpload.onchange = handlePhotoChange;
                document.getElementById('member-modal-cancel-button').onclick = () => {
                    setState({ showAddMemberModal: false, editingMember: null });
                };
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('overflow-hidden');
            }
        }

        function renderMemberDetailsModal() {
            const modal = document.getElementById('member-details-modal');
            const currentTranslations = translations[appState.language];

            if (appState.selectedMember) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.classList.add('overflow-hidden');

                document.getElementById('member-details-title').textContent = currentTranslations.memberDetails;
                document.getElementById('details-first-name').textContent = appState.selectedMember.firstName;
                document.getElementById('details-last-name').textContent = appState.selectedMember.lastName;
                document.getElementById('details-gender').textContent = appState.selectedMember.gender;
                document.getElementById('details-date-of-birth').textContent = appState.selectedMember.dateOfBirth;
                document.getElementById('details-member-class').textContent = appState.selectedMember.memberClass;
                document.getElementById('details-status').textContent = appState.selectedMember.status;
                document.getElementById('details-from-address-origin').textContent = appState.selectedMember.from;
                document.getElementById('details-service').textContent = appState.selectedMember.service;
                document.getElementById('details-phone-number').textContent = appState.selectedMember.phone;
                document.getElementById('details-emergency-number').textContent = appState.selectedMember.emergencyNumber;

                const facebookContainer = document.getElementById('details-facebook-container');
                const telegramContainer = document.getElementById('details-telegram-container');

                if (appState.selectedMember.facebook) {
                    document.getElementById('details-facebook').textContent = appState.selectedMember.facebook;
                    facebookContainer.classList.remove('hidden');
                } else {
                    facebookContainer.classList.add('hidden');
                }

                if (appState.selectedMember.telegram) {
                    document.getElementById('details-telegram').textContent = appState.selectedMember.telegram;
                    telegramContainer.classList.remove('hidden');
                } else {
                    telegramContainer.classList.add('hidden');
                }

                const photoContainer = document.getElementById('member-details-photo-container');
                const photoImg = document.getElementById('member-details-photo');
                if (appState.selectedMember.photo) {
                    photoImg.src = appState.selectedMember.photo;
                    photoContainer.classList.remove('hidden');
                } else {
                    photoContainer.classList.add('hidden');
                }

                document.getElementById('member-details-close-button').onclick = () => {
                    setState({ selectedMember: null });
                };
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('overflow-hidden');
            }
        }

        function renderAddEditEventModal() {
            const modal = document.getElementById('add-edit-event-modal');
            const form = document.getElementById('event-form');
            const title = document.getElementById('event-modal-title');
            const submitButton = document.getElementById('event-modal-submit-button');

            const currentTranslations = translations[appState.language];

            if (appState.showAddEventModal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.classList.add('overflow-hidden');

                if (appState.editingEvent) {
                    title.textContent = currentTranslations.editEvent;
                    submitButton.textContent = currentTranslations.saveChanges;
                    // Populate form fields
                    document.getElementById('event-name').value = appState.editingEvent.name;
                    document.getElementById('event-date').value = appState.editingEvent.date;
                    document.getElementById('event-time').value = appState.editingEvent.time;
                    document.getElementById('event-location').value = appState.editingEvent.location;
                    document.getElementById('event-service').value = appState.editingEvent.service;
                    document.getElementById('event-team').value = appState.editingEvent.team;
                    document.getElementById('event-description').value = appState.editingEvent.description;
                } else {
                    title.textContent = currentTranslations.addEvent;
                    submitButton.textContent = currentTranslations.addEvent;
                    form.reset(); // Clear form for new event
                }

                form.onsubmit = handleEventFormSubmit;
                document.getElementById('event-modal-cancel-button').onclick = () => {
                    setState({ showAddEventModal: false, editingEvent: null });
                };
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('overflow-hidden');
            }
        }

        function renderLargePhotoModal() {
            const modal = document.getElementById('large-photo-modal');
            const img = document.getElementById('large-photo-img');

            if (appState.showPhotoModal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.classList.add('overflow-hidden');
                img.src = appState.largePhotoUrl;
                document.getElementById('large-photo-close-button').onclick = () => {
                    setState({ showPhotoModal: false, largePhotoUrl: '' });
                };
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('overflow-hidden');
            }
        }

        function renderDeleteConfirmModal() {
            const modal = document.getElementById('delete-confirm-modal');
            const message = document.getElementById('delete-confirm-message');
            const currentTranslations = translations[appState.language];

            if (appState.showDeleteConfirmModal && appState.memberToDelete) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.classList.add('overflow-hidden');
                message.textContent = currentTranslations.deleteConfirmation.replace('{memberName}', appState.memberToDelete.name);
                document.getElementById('delete-confirm-button').onclick = handleDeleteMember;
                document.getElementById('delete-cancel-button').onclick = () => {
                    setState({ showDeleteConfirmModal: false, memberToDelete: null });
                };
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('overflow-hidden');
            }
        }


        // Main render function
        function render() {
            updateTranslations(); // Update all static texts based on current language
            applyTheme(); // Apply theme classes

            const dashboardBtn = document.getElementById('dashboard-nav-button');
            const membersBtn = document.getElementById('members-nav-button');
            const eventsBtn = document.getElementById('events-nav-button');
            const reportsBtn = document.getElementById('reports-nav-button');
            const settingsHeaderBtn = document.getElementById('settings-button'); // This is the settings button in the header

            // Apply default classes to all nav buttons first
            [dashboardBtn, membersBtn, eventsBtn, reportsBtn].forEach(btn => {
                if (btn) { // Null check
                    btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-medium', 'dark:bg-indigo-700', 'dark:text-white');
                    btn.classList.add('text-gray-700', 'hover:bg-gray-50', 'dark:text-gray-300', 'dark:hover:bg-gray-700');
                }
            });
            // Also reset the settings button in the header
            if (settingsHeaderBtn) {
                settingsHeaderBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-medium', 'dark:bg-indigo-700', 'dark:text-white');
                settingsHeaderBtn.classList.add('text-gray-700', 'hover:bg-gray-50', 'dark:text-gray-300', 'dark:hover:bg-gray-700');
            }


            // Apply active classes to the current active section's nav button
            const activeNavButton = document.getElementById(`${appState.activeSection}-nav-button`);
            if (activeNavButton) { // Null check
                activeNavButton.classList.add('bg-indigo-100', 'text-indigo-700', 'font-medium', 'dark:bg-indigo-700', 'dark:text-white');
                activeNavButton.classList.remove('text-gray-700', 'hover:bg-gray-50', 'dark:text-gray-300', 'dark:hover:bg-gray-700');
            }

            // Special handling for the settings button in the header if settings section is active
            if (appState.activeSection === 'settings' && settingsHeaderBtn) { // Null check
                settingsHeaderBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'font-medium', 'dark:bg-indigo-700', 'dark:text-white');
                settingsHeaderBtn.classList.remove('text-gray-700', 'hover:bg-gray-50', 'dark:text-gray-300', 'dark:hover:bg-gray-700');
            }


            // Show/hide loading indicator
            if (appState.isLoading) {
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('content-area').classList.add('hidden');
            } else {
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('content-area').classList.remove('hidden');
                // Render content based on active section
                switch (appState.activeSection) {
                    case 'dashboard':
                        renderDashboard();
                        break;
                    case 'members':
                        renderMembers();
                        break;
                    case 'events':
                        renderEvents();
                        break;
                    case 'reports':
                        renderReports();
                        break;
                    case 'settings':
                        renderSettings();
                        break;
                    default:
                        renderDashboard();
                }
            }

            // Render Modals
            renderAddEditMemberModal();
            renderMemberDetailsModal();
            renderAddEditEventModal();
            renderLargePhotoModal();
            renderDeleteConfirmModal();
        }

        // --- Event Handlers (Mirroring React Logic) ---

        function toggleTheme() {
            setState({ theme: appState.theme === 'light' ? 'dark' : 'light' });
        }

        function handleMemberFormChange(e) {
            const { name, value } = e.target;
            if (appState.editingMember) {
                setState({ editingMember: { ...appState.editingMember, [name]: value } });
            } else {
                setState({ newMember: { ...appState.newMember, [name]: value } });
            }
        }

        function handlePhotoChange(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    if (appState.editingMember) {
                        setState({ editingMember: { ...appState.editingMember, photo: reader.result } });
                    } else {
                        setState({ newMember: { ...appState.newMember, photo: reader.result } });
                    }
                };
                reader.readAsDataURL(file);
            } else {
                if (appState.editingMember) {
                    setState({ editingMember: { ...appState.editingMember, photo: '' } });
                } else {
                    setState({ newMember: { ...appState.newMember, photo: '' } });
                }
            }
        }

        function handleMemberFormSubmit(e) {
            e.preventDefault();
            setState({ isLoading: true }, () => {
                setTimeout(() => {
                    let updatedMembers;
                    if (appState.editingMember) {
                        updatedMembers = appState.members.map((member) =>
                            member.id === appState.editingMember.id
                                ? { ...appState.editingMember, name: `${appState.editingMember.firstName} ${appState.editingMember.lastName}` }
                                : member
                        );
                    } else {
                        const newId = appState.members.length > 0 ? Math.max(...appState.members.map(m => m.id)) + 1 : 1;
                        updatedMembers = [
                            ...appState.members,
                            {
                                id: newId,
                                name: `${appState.newMember.firstName} ${appState.newMember.lastName}`,
                                status: appState.newMember.status || 'Active',
                                gender: appState.newMember.gender,
                                phone: appState.newMember.phoneNumber,
                                service: appState.newMember.service || 'Other',
                                photo: appState.newMember.photo,
                                facebook: appState.newMember.facebook,
                                telegram: appState.newMember.telegram,
                                lastName: appState.newMember.lastName,
                                firstName: appState.newMember.firstName,
                                dateOfBirth: appState.newMember.dateOfBirth,
                                memberClass: appState.newMember.memberClass,
                                from: appState.newMember.from,
                                emergencyNumber: appState.newMember.emergencyNumber,
                            },
                        ];
                    }
                    setState({
                        members: updatedMembers,
                        newMember: { lastName: '', firstName: '', gender: '', dateOfBirth: '', memberClass: '', status: '', from: '', service: '', phoneNumber: '', emergencyNumber: '', photo: '', facebook: '', telegram: '' },
                        showAddMemberModal: false,
                        editingMember: null,
                        isLoading: false,
                    });
                }, 1000);
            });
        }

        function handleDeleteMember() {
            setState({ isLoading: true }, () => {
                setTimeout(() => {
                    const updatedMembers = appState.members.filter((member) => member.id !== appState.memberToDelete.id);
                    setState({
                        members: updatedMembers,
                        showDeleteConfirmModal: false,
                        memberToDelete: null,
                        isLoading: false,
                    });
                }, 500);
            });
        }

        function handleImportExcel(event) {
            setState({ isLoading: true });
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                        setTimeout(() => {
                            const importedMembers = worksheet.map((row, index) => ({
                                id: appState.members.length + index + 1,
                                name: row['Name'] || `${row['First Name'] || ''} ${row['Last Name'] || ''}`.trim(),
                                status: row['Status'] || 'Active',
                                gender: row['Gender'] || 'Unknown',
                                phone: row['Phone Number'] || '',
                                service: row['Service'] || 'Other',
                                photo: row['Photo'] || '',
                                facebook: row['Facebook'] || '',
                                telegram: row['Telegram'] || '',
                                lastName: row['Last Name'] || '',
                                firstName: row['First Name'] || '',
                                dateOfBirth: row['Date of Birth'] || '',
                                memberClass: row['Class'] || '',
                                from: row['From'] || '',
                                emergencyNumber: row['Emergency Number'] || '',
                            }));

                            setState({
                                members: [...appState.members, ...importedMembers],
                                fileInputKey: Date.now(), // Reset file input
                                isLoading: false,
                            });
                            console.log('Successfully imported members:', importedMembers);
                        }, 1500);
                    } catch (error) {
                        console.error('Error importing Excel file:', error);
                        alert('Failed to import Excel file. Please ensure it is a valid Excel format and columns match expected headers.');
                        setState({ isLoading: false });
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                setState({ isLoading: false });
            }
        }

        function handleExportExcel() {
            setState({ isLoading: true }, () => {
                setTimeout(() => {
                    const headers = ["ID", "Name", "Status", "Gender", "Phone", "Service", "Facebook", "Telegram", "Last Name", "First Name", "Date of Birth", "Class", "From", "Emergency Number"];
                    const rows = appState.members.map(member => [
                        member.id,
                        member.name,
                        member.status,
                        member.gender,
                        member.phone,
                        member.service,
                        member.facebook,
                        member.telegram,
                        member.lastName,
                        member.firstName,
                        member.dateOfBirth,
                        member.memberClass,
                        member.from,
                        member.emergencyNumber,
                    ]);

                    const csvContent = [
                        headers.join(','),
                        ...rows.map(e => e.join(','))
                    ].join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', 'church_members.csv');
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        alert('Your browser does not support downloading files directly. Please copy the data manually.');
                    }
                    setState({ isLoading: false });
                }, 1000);
            });
        }

        function handleExportPdf() {
            setState({ isLoading: true }, () => {
                setTimeout(() => {
                    if (!appState.isJsPdfLoaded) {
                        console.error('jsPDF library not loaded. Please ensure the CDN scripts are loaded correctly.');
                        alert('PDF export is not ready. Please try again or refresh the page.');
                        setState({ isLoading: false });
                        return;
                    }

                    const doc = new window.jspdf.jsPDF();
                    const currentTranslations = translations[appState.language];

                    doc.setFontSize(18);
                    doc.text(currentTranslations.membersList, 14, 22);

                    doc.setFontSize(11);
                    const tableColumn = [
                        "ID",
                        currentTranslations.name,
                        currentTranslations.status,
                        currentTranslations.addMember,
                        currentTranslations.phone
                    ];
                    const tableRows = [];

                    appState.members.forEach(member => {
                        const memberData = [
                            member.id,
                            member.name,
                            member.status,
                            member.gender,
                            member.phone,
                        ];
                        tableRows.push(memberData);
                    });

                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 30,
                        styles: {
                            fontSize: 8,
                            cellPadding: 2,
                            halign: 'left'
                        },
                        headStyles: {
                            fillColor: [67, 56, 202],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold'
                        },
                        alternateRowStyles: {
                            fillColor: [243, 244, 246]
                        },
                        theme: 'grid'
                    });

                    doc.save('church_members.pdf');
                    setState({ isLoading: false });
                }, 1000);
            });
        }

        function handleEventFormChange(e) {
            const { name, value } = e.target;
            if (appState.editingEvent) {
                setState({ editingEvent: { ...appState.editingEvent, [name]: value } });
            } else {
                setState({ newEvent: { ...appState.newEvent, [name]: value } });
            }
        }

        function handleEventFormSubmit(e) {
            e.preventDefault();
            setState({ isLoading: true }, () => {
                setTimeout(() => {
                    let updatedEvents;
                    if (appState.editingEvent) {
                        updatedEvents = appState.events.map((event) =>
                            event.id === appState.editingEvent.id ? appState.editingEvent : event
                        );
                    } else {
                        const newId = appState.events.length > 0 ? Math.max(...appState.events.map(ev => ev.id)) + 1 : 1;
                        updatedEvents = [
                            ...appState.events,
                            { id: newId, ...appState.newEvent },
                        ];
                    }
                    setState({
                        events: updatedEvents,
                        newEvent: { name: '', date: '', time: '', location: '', description: '', service: '', team: '' },
                        showAddEventModal: false,
                        editingEvent: null,
                        isLoading: false,
                    });
                }, 1000);
            });
        }

        function handleGenerateReport() {
            setState({ isLoading: true, generatedReportData: null }, () => {
                setTimeout(() => {
                    let reportData = null;
                    if (appState.selectedReportType === 'Monthly Membership Comparison') {
                        reportData = appState.monthlyMembershipData;
                    } else {
                        reportData = { message: `Generating ${appState.selectedReportType} Report... (Not implemented yet)` };
                    }
                    setState({
                        generatedReportData: reportData,
                        isLoading: false,
                    });
                }, 1000);
            });
        }

        // Initial load and event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Simulate data loading
            setTimeout(() => {
                setState({ isLoading: false });
            }, 1500);

            // Load jsPDF scripts
            let scriptsLoadedCount = 0;
            const totalScripts = 2;
            const onScriptLoad = () => {
                scriptsLoadedCount++;
                if (scriptsLoadedCount === totalScripts) {
                    if (window.jspdf && typeof window.jspdf.jsPDF === 'function') {
                        setState({ isJsPdfLoaded: true });
                    } else {
                        console.error("jsPDF constructor not found under window.jspdf.jsPDF after script load.");
                    }
                }
            };

            const loadScript = (src, id, callback) => {
                if (document.getElementById(id)) {
                    callback();
                    return;
                }
                const script = document.createElement('script');
                script.src = src;
                script.id = id;
                script.onload = callback;
                script.onerror = () => console.error(`Failed to load script: ${src}`);
                document.head.appendChild(script);
            };

            loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js", "jspdf-script", onScriptLoad);
            loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js", "jspdf-autotable-script", onScriptLoad);


            // Navigation button event listeners
            document.getElementById('dashboard-nav-button').addEventListener('click', () => setState({ activeSection: 'dashboard' }));
            document.getElementById('members-nav-button').addEventListener('click', () => setState({ activeSection: 'members' }));
            document.getElementById('events-nav-button').addEventListener('click', () => setState({ activeSection: 'events' }));
            document.getElementById('reports-nav-button').addEventListener('click', () => setState({ activeSection: 'reports' }));
            document.getElementById('settings-button').addEventListener('click', () => setState({ activeSection: 'settings' }));
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        });
    </script>
</body>
</html>
